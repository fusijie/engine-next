var engine=function(){"use strict";const t=Math.PI/180;const e=180/Math.PI;const n=1e-6;function r(t,e){return Math.abs(t-e)<=n*Math.max(1,Math.abs(t),Math.abs(e))}function a(t,e,r){r=r||n;return Math.abs(t-e)<=r}function s(t,e,n){return t<e?e:t>n?n:t}function i(t){return t<0?0:t>1?1:t}function m(t,e,n){return t+(e-t)*n}function o(e){return e*t}function l(t){return t*e}const u=Math.random;function h(t,e){return Math.random()*(e-t)+t}function f(t,e){return Math.floor(h(t,e))}function c(t){--t;t=t>>1|t;t=t>>2|t;t=t>>4|t;t=t>>8|t;t=t>>16|t;++t;return t}const _=32;const d=2147483647;const x=-1<<_-1;function g(t){return(t>0)-(t<0)}function p(t){let e=t>>_-1;return(t^e)-e}function y(t,e){return e^(t^e)&-(t<e)}function M(t,e){return t^(t^e)&-(t<e)}function w(t){return!(t&t-1)&&!!t}function A(t){let e,n;e=(t>65535)<<4;t>>>=e;n=(t>255)<<3;t>>>=n;e|=n;n=(t>15)<<2;t>>>=n;e|=n;n=(t>3)<<1;t>>>=n;e|=n;return e|t>>1}function v(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0}function S(t){t=t-(t>>>1&1431655765);t=(t&858993459)+(t>>>2&858993459);return(t+(t>>>4)&252645135)*16843009>>>24}function b(t){let e=32;t&=-t;if(t)e--;if(t&65535)e-=16;if(t&16711935)e-=8;if(t&252645135)e-=4;if(t&858993459)e-=2;if(t&1431655765)e-=1;return e}function E(t){t+=t===0;--t;t|=t>>>1;t|=t>>>2;t|=t>>>4;t|=t>>>8;t|=t>>>16;return t+1}function z(t){t|=t>>>1;t|=t>>>2;t|=t>>>4;t|=t>>>8;t|=t>>>16;return t-(t>>>1)}function T(t){t^=t>>>16;t^=t>>>8;t^=t>>>4;t&=15;return 27030>>>t&1}const P=new Array(256);(function(t){for(let e=0;e<256;++e){let n=e,r=e,a=7;for(n>>>=1;n;n>>>=1){r<<=1;r|=n&1;--a}t[e]=r<<a&255}})(P);function R(t){return P[t&255]<<24|P[t>>>8&255]<<16|P[t>>>16&255]<<8|P[t>>>24&255]}function L(t,e){t&=65535;t=(t|t<<8)&16711935;t=(t|t<<4)&252645135;t=(t|t<<2)&858993459;t=(t|t<<1)&1431655765;e&=65535;e=(e|e<<8)&16711935;e=(e|e<<4)&252645135;e=(e|e<<2)&858993459;e=(e|e<<1)&1431655765;return t|e<<1}function C(t,e){t=t>>>e&1431655765;t=(t|t>>>1)&858993459;t=(t|t>>>2)&252645135;t=(t|t>>>4)&16711935;t=(t|t>>>16)&65535;return t<<16>>16}function D(t,e,n){t&=1023;t=(t|t<<16)&4278190335;t=(t|t<<8)&251719695;t=(t|t<<4)&3272356035;t=(t|t<<2)&1227133513;e&=1023;e=(e|e<<16)&4278190335;e=(e|e<<8)&251719695;e=(e|e<<4)&3272356035;e=(e|e<<2)&1227133513;t|=e<<1;n&=1023;n=(n|n<<16)&4278190335;n=(n|n<<8)&251719695;n=(n|n<<4)&3272356035;n=(n|n<<2)&1227133513;return t|n<<2}function O(t,e){t=t>>>e&1227133513;t=(t|t>>>2)&3272356035;t=(t|t>>>4)&251719695;t=(t|t>>>8)&4278190335;t=(t|t>>>16)&1023;return t<<22>>22}function I(t){let e=t|t-1;return e+1|(~e&-~e)-1>>>b(t)+1}var N=Object.freeze({INT_BITS:_,INT_MAX:d,INT_MIN:x,sign:g,abs:p,min:y,max:M,isPow2:w,log2:A,log10:v,popCount:S,countTrailingZeros:b,nextPow2:E,prevPow2:z,parity:T,reverse:R,interleave2:L,deinterleave2:C,interleave3:D,deinterleave3:O,nextCombination:I});let F=new Array(2);class B{constructor(t,e){this.x=t;this.y=e}toJSON(){F[0]=this.x;F[1]=this.y;return F}}let U={};U.create=function(){return new B(0,0)};U.new=function(t,e){return new B(t,e)};U.clone=function(t){return new B(t.x,t.y)};U.copy=function(t,e){t.x=e.x;t.y=e.y;return t};U.set=function(t,e,n){t.x=e;t.y=n;return t};U.add=function(t,e,n){t.x=e.x+n.x;t.y=e.y+n.y;return t};U.subtract=function(t,e,n){t.x=e.x-n.x;t.y=e.y-n.y;return t};U.sub=U.subtract;U.multiply=function(t,e,n){t.x=e.x*n.x;t.y=e.y*n.y;return t};U.mul=U.multiply;U.divide=function(t,e,n){t.x=e.x/n.x;t.y=e.y/n.y;return t};U.div=U.divide;U.ceil=function(t,e){t.x=Math.ceil(e.x);t.y=Math.ceil(e.y);return t};U.floor=function(t,e){t.x=Math.floor(e.x);t.y=Math.floor(e.y);return t};U.min=function(t,e,n){t.x=Math.min(e.x,n.x);t.y=Math.min(e.y,n.y);return t};U.max=function(t,e,n){t.x=Math.max(e.x,n.x);t.y=Math.max(e.y,n.y);return t};U.round=function(t,e){t.x=Math.round(e.x);t.y=Math.round(e.y);return t};U.scale=function(t,e,n){t.x=e.x*n;t.y=e.y*n;return t};U.scaleAndAdd=function(t,e,n,r){t.x=e.x+n.x*r;t.y=e.y+n.y*r;return t};U.distance=function(t,e){let n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)};U.dist=U.distance;U.squaredDistance=function(t,e){let n=e.x-t.x,r=e.y-t.y;return n*n+r*r};U.sqrDist=U.squaredDistance;U.length=function(t){let e=t.x,n=t.y;return Math.sqrt(e*e+n*n)};U.len=U.length;U.squaredLength=function(t){let e=t.x,n=t.y;return e*e+n*n};U.sqrLen=U.squaredLength;U.negate=function(t,e){t.x=-e.x;t.y=-e.y;return t};U.inverse=function(t,e){t.x=1/e.x;t.y=1/e.y;return t};U.inverseSafe=function(t,e){let r=e.x,a=e.y;if(Math.abs(r)<n){t.x=0}else{t.x=1/r}if(Math.abs(a)<n){t.y=0}else{t.y=1/e.y}return t};U.normalize=function(t,e){let n=e.x,r=e.y;let a=n*n+r*r;if(a>0){a=1/Math.sqrt(a);t.x=e.x*a;t.y=e.y*a}return t};U.dot=function(t,e){return t.x*e.x+t.y*e.y};U.cross=function(t,e,n){let r=e.x*n.y-e.y*n.x;t.x=t.y=0;t.z=r;return t};U.lerp=function(t,e,n,r){let a=e.x,s=e.y;t.x=a+r*(n.x-a);t.y=s+r*(n.y-s);return t};U.random=function(t,e){e=e||1;let n=u()*2*Math.PI;t.x=Math.cos(n)*e;t.y=Math.sin(n)*e;return t};U.transformMat2=function(t,e,n){let r=e.x,a=e.y;t.x=n.m00*r+n.m02*a;t.y=n.m01*r+n.m03*a;return t};U.transformMat23=function(t,e,n){let r=e.x,a=e.y;t.x=n.m00*r+n.m02*a+n.m04;t.y=n.m01*r+n.m03*a+n.m05;return t};U.transformMat3=function(t,e,n){let r=e.x,a=e.y;t.x=n.m00*r+n.m03*a+n.m06;t.y=n.m01*r+n.m04*a+n.m07;return t};U.transformMat4=function(t,e,n){let r=e.x,a=e.y;t.x=n.m00*r+n.m04*a+n.m12;t.y=n.m01*r+n.m05*a+n.m13;return t};U.forEach=function(){let t=U.create();return function(e,n,r,a,s,i){let m,o;if(!n){n=2}if(!r){r=0}if(a){o=Math.min(a*n+r,e.length)}else{o=e.length}for(m=r;m<o;m+=n){t.x=e[m];t.y=e[m+1];s(t,t,i);e[m]=t.x;e[m+1]=t.y}return e}}();U.str=function(t){return`vec2(${t.x}, ${t.y})`};U.array=function(t,e){t[0]=e.x;t[1]=e.y;return t};U.exactEquals=function(t,e){return t.x===e.x&&t.y===e.y};U.equals=function(t,e){let r=t.x,a=t.y;let s=e.x,i=e.y;return Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(a-i)<=n*Math.max(1,Math.abs(a),Math.abs(i))};let V=new Array(3);class q{constructor(t,e,n){this.x=t;this.y=e;this.z=n}toJSON(){V[0]=this.x;V[1]=this.y;V[2]=this.z;return V}}let k={};k.create=function(){return new q(0,0,0)};k.new=function(t,e,n){return new q(t,e,n)};k.clone=function(t){return new q(t.x,t.y,t.z)};k.copy=function(t,e){t.x=e.x;t.y=e.y;t.z=e.z;return t};k.set=function(t,e,n,r){t.x=e;t.y=n;t.z=r;return t};k.add=function(t,e,n){t.x=e.x+n.x;t.y=e.y+n.y;t.z=e.z+n.z;return t};k.subtract=function(t,e,n){t.x=e.x-n.x;t.y=e.y-n.y;t.z=e.z-n.z;return t};k.sub=k.subtract;k.multiply=function(t,e,n){t.x=e.x*n.x;t.y=e.y*n.y;t.z=e.z*n.z;return t};k.mul=k.multiply;k.divide=function(t,e,n){t.x=e.x/n.x;t.y=e.y/n.y;t.z=e.z/n.z;return t};k.div=k.divide;k.ceil=function(t,e){t.x=Math.ceil(e.x);t.y=Math.ceil(e.y);t.z=Math.ceil(e.z);return t};k.floor=function(t,e){t.x=Math.floor(e.x);t.y=Math.floor(e.y);t.z=Math.floor(e.z);return t};k.min=function(t,e,n){t.x=Math.min(e.x,n.x);t.y=Math.min(e.y,n.y);t.z=Math.min(e.z,n.z);return t};k.max=function(t,e,n){t.x=Math.max(e.x,n.x);t.y=Math.max(e.y,n.y);t.z=Math.max(e.z,n.z);return t};k.round=function(t,e){t.x=Math.round(e.x);t.y=Math.round(e.y);t.z=Math.round(e.z);return t};k.scale=function(t,e,n){t.x=e.x*n;t.y=e.y*n;t.z=e.z*n;return t};k.scaleAndAdd=function(t,e,n,r){t.x=e.x+n.x*r;t.y=e.y+n.y*r;t.z=e.z+n.z*r;return t};k.distance=function(t,e){let n=e.x-t.x,r=e.y-t.y,a=e.z-t.z;return Math.sqrt(n*n+r*r+a*a)};k.dist=k.distance;k.squaredDistance=function(t,e){let n=e.x-t.x,r=e.y-t.y,a=e.z-t.z;return n*n+r*r+a*a};k.sqrDist=k.squaredDistance;k.length=function(t){let e=t.x,n=t.y,r=t.z;return Math.sqrt(e*e+n*n+r*r)};k.len=k.length;k.squaredLength=function(t){let e=t.x,n=t.y,r=t.z;return e*e+n*n+r*r};k.sqrLen=k.squaredLength;k.negate=function(t,e){t.x=-e.x;t.y=-e.y;t.z=-e.z;return t};k.inverse=function(t,e){t.x=1/e.x;t.y=1/e.y;t.z=1/e.z;return t};k.inverseSafe=function(t,e){let r=e.x,a=e.y,s=e.z;if(Math.abs(r)<n){t.x=0}else{t.x=1/r}if(Math.abs(a)<n){t.y=0}else{t.y=1/a}if(Math.abs(s)<n){t.z=0}else{t.z=1/s}return t};k.normalize=function(t,e){let n=e.x,r=e.y,a=e.z;let s=n*n+r*r+a*a;if(s>0){s=1/Math.sqrt(s);t.x=n*s;t.y=r*s;t.z=a*s}return t};k.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z};k.cross=function(t,e,n){let r=e.x,a=e.y,s=e.z,i=n.x,m=n.y,o=n.z;t.x=a*o-s*m;t.y=s*i-r*o;t.z=r*m-a*i;return t};k.lerp=function(t,e,n,r){let a=e.x,s=e.y,i=e.z;t.x=a+r*(n.x-a);t.y=s+r*(n.y-s);t.z=i+r*(n.z-i);return t};k.hermite=function(t,e,n,r,a,s){let i=s*s,m=i*(2*s-3)+1,o=i*(s-2)+s,l=i*(s-1),u=i*(3-2*s);t.x=e.x*m+n.x*o+r.x*l+a.x*u;t.y=e.y*m+n.y*o+r.y*l+a.y*u;t.z=e.z*m+n.z*o+r.z*l+a.z*u;return t};k.bezier=function(t,e,n,r,a,s){let i=1-s,m=i*i,o=s*s,l=m*i,u=3*s*m,h=3*o*i,f=o*s;t.x=e.x*l+n.x*u+r.x*h+a.x*f;t.y=e.y*l+n.y*u+r.y*h+a.y*f;t.z=e.z*l+n.z*u+r.z*h+a.z*f;return t};k.random=function(t,e){e=e||1;let n=u()*2*Math.PI;let r=u()*2-1;let a=Math.sqrt(1-r*r)*e;t.x=Math.cos(n)*a;t.y=Math.sin(n)*a;t.z=r*e;return t};k.transformMat4=function(t,e,n){let r=e.x,a=e.y,s=e.z,i=n.m03*r+n.m07*a+n.m11*s+n.m15;i=i||1;t.x=(n.m00*r+n.m04*a+n.m08*s+n.m12)/i;t.y=(n.m01*r+n.m05*a+n.m09*s+n.m13)/i;t.z=(n.m02*r+n.m06*a+n.m10*s+n.m14)/i;return t};k.transformMat3=function(t,e,n){let r=e.x,a=e.y,s=e.z;t.x=r*n.m00+a*n.m03+s*n.m06;t.y=r*n.m01+a*n.m04+s*n.m07;t.z=r*n.m02+a*n.m05+s*n.m08;return t};k.transformQuat=function(t,e,n){let r=e.x,a=e.y,s=e.z;let i=n.x,m=n.y,o=n.z,l=n.w;let u=l*r+m*s-o*a;let h=l*a+o*r-i*s;let f=l*s+i*a-m*r;let c=-i*r-m*a-o*s;t.x=u*l+c*-i+h*-o-f*-m;t.y=h*l+c*-m+f*-i-u*-o;t.z=f*l+c*-o+u*-m-h*-i;return t};k.rotateX=function(t,e,n,r){let a=[],s=[];a.x=e.x-n.x;a.y=e.y-n.y;a.z=e.z-n.z;s.x=a.x;s.y=a.y*Math.cos(r)-a.z*Math.sin(r);s.z=a.y*Math.sin(r)+a.z*Math.cos(r);t.x=s.x+n.x;t.y=s.y+n.y;t.z=s.z+n.z;return t};k.rotateY=function(t,e,n,r){let a=[],s=[];a.x=e.x-n.x;a.y=e.y-n.y;a.z=e.z-n.z;s.x=a.z*Math.sin(r)+a.x*Math.cos(r);s.y=a.y;s.z=a.z*Math.cos(r)-a.x*Math.sin(r);t.x=s.x+n.x;t.y=s.y+n.y;t.z=s.z+n.z;return t};k.rotateZ=function(t,e,n,r){let a=[],s=[];a.x=e.x-n.x;a.y=e.y-n.y;a.z=e.z-n.z;s.x=a.x*Math.cos(r)-a.y*Math.sin(r);s.y=a.x*Math.sin(r)+a.y*Math.cos(r);s.z=a.z;t.x=s.x+n.x;t.y=s.y+n.y;t.z=s.z+n.z;return t};k.forEach=function(){let t=k.create();return function(e,n,r,a,s,i){let m,o;if(!n){n=3}if(!r){r=0}if(a){o=Math.min(a*n+r,e.length)}else{o=e.length}for(m=r;m<o;m+=n){t.x=e[m];t.y=e[m+1];t.z=e[m+2];s(t,t,i);e[m]=t.x;e[m+1]=t.y;e[m+2]=t.z}return e}}();k.angle=function(){let t=k.create();let e=k.create();return function(n,r){k.copy(t,n);k.copy(e,r);k.normalize(t,t);k.normalize(e,e);let a=k.dot(t,e);if(a>1){return 0}if(a<-1){return Math.PI}return Math.acos(a)}}();k.str=function(t){return`vec3(${t.x}, ${t.y}, ${t.z})`};k.array=function(t,e){t[0]=e.x;t[1]=e.y;t[2]=e.z;return t};k.exactEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z};k.equals=function(t,e){let r=t.x,a=t.y,s=t.z;let i=e.x,m=e.y,o=e.z;return Math.abs(r-i)<=n*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(a-m)<=n*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(s-o)<=n*Math.max(1,Math.abs(s),Math.abs(o))};let j=new Array(4);class H{constructor(t,e,n,r){this.x=t;this.y=e;this.z=n;this.w=r}toJSON(){j[0]=this.x;j[1]=this.y;j[2]=this.z;j[3]=this.w;return j}}let $={};$.create=function(){return new H(0,0,0,0)};$.new=function(t,e,n,r){return new H(t,e,n,r)};$.clone=function(t){return new H(t.x,t.y,t.z,t.w)};$.copy=function(t,e){t.x=e.x;t.y=e.y;t.z=e.z;t.w=e.w;return t};$.set=function(t,e,n,r,a){t.x=e;t.y=n;t.z=r;t.w=a;return t};$.add=function(t,e,n){t.x=e.x+n.x;t.y=e.y+n.y;t.z=e.z+n.z;t.w=e.w+n.w;return t};$.subtract=function(t,e,n){t.x=e.x-n.x;t.y=e.y-n.y;t.z=e.z-n.z;t.w=e.w-n.w;return t};$.sub=$.subtract;$.multiply=function(t,e,n){t.x=e.x*n.x;t.y=e.y*n.y;t.z=e.z*n.z;t.w=e.w*n.w;return t};$.mul=$.multiply;$.divide=function(t,e,n){t.x=e.x/n.x;t.y=e.y/n.y;t.z=e.z/n.z;t.w=e.w/n.w;return t};$.div=$.divide;$.ceil=function(t,e){t.x=Math.ceil(e.x);t.y=Math.ceil(e.y);t.z=Math.ceil(e.z);t.w=Math.ceil(e.w);return t};$.floor=function(t,e){t.x=Math.floor(e.x);t.y=Math.floor(e.y);t.z=Math.floor(e.z);t.w=Math.floor(e.w);return t};$.min=function(t,e,n){t.x=Math.min(e.x,n.x);t.y=Math.min(e.y,n.y);t.z=Math.min(e.z,n.z);t.w=Math.min(e.w,n.w);return t};$.max=function(t,e,n){t.x=Math.max(e.x,n.x);t.y=Math.max(e.y,n.y);t.z=Math.max(e.z,n.z);t.w=Math.max(e.w,n.w);return t};$.round=function(t,e){t.x=Math.round(e.x);t.y=Math.round(e.y);t.z=Math.round(e.z);t.w=Math.round(e.w);return t};$.scale=function(t,e,n){t.x=e.x*n;t.y=e.y*n;t.z=e.z*n;t.w=e.w*n;return t};$.scaleAndAdd=function(t,e,n,r){t.x=e.x+n.x*r;t.y=e.y+n.y*r;t.z=e.z+n.z*r;t.w=e.w+n.w*r;return t};$.distance=function(t,e){let n=e.x-t.x,r=e.y-t.y,a=e.z-t.z,s=e.w-t.w;return Math.sqrt(n*n+r*r+a*a+s*s)};$.dist=$.distance;$.squaredDistance=function(t,e){let n=e.x-t.x,r=e.y-t.y,a=e.z-t.z,s=e.w-t.w;return n*n+r*r+a*a+s*s};$.sqrDist=$.squaredDistance;$.length=function(t){let e=t.x,n=t.y,r=t.z,a=t.w;return Math.sqrt(e*e+n*n+r*r+a*a)};$.len=$.length;$.squaredLength=function(t){let e=t.x,n=t.y,r=t.z,a=t.w;return e*e+n*n+r*r+a*a};$.sqrLen=$.squaredLength;$.negate=function(t,e){t.x=-e.x;t.y=-e.y;t.z=-e.z;t.w=-e.w;return t};$.inverse=function(t,e){t.x=1/e.x;t.y=1/e.y;t.z=1/e.z;t.w=1/e.w;return t};$.inverseSafe=function(t,e){let r=e.x,a=e.y,s=e.z,i=e.w;if(Math.abs(r)<n){t.x=0}else{t.x=1/r}if(Math.abs(a)<n){t.y=0}else{t.y=1/a}if(Math.abs(s)<n){t.z=0}else{t.z=1/s}if(Math.abs(i)<n){t.w=0}else{t.w=1/i}return t};$.normalize=function(t,e){let n=e.x,r=e.y,a=e.z,s=e.w;let i=n*n+r*r+a*a+s*s;if(i>0){i=1/Math.sqrt(i);t.x=n*i;t.y=r*i;t.z=a*i;t.w=s*i}return t};$.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w};$.lerp=function(t,e,n,r){let a=e.x,s=e.y,i=e.z,m=e.w;t.x=a+r*(n.x-a);t.y=s+r*(n.y-s);t.z=i+r*(n.z-i);t.w=m+r*(n.w-m);return t};$.random=function(t,e){e=e||1;t.x=u();t.y=u();t.z=u();t.w=u();$.normalize(t,t);$.scale(t,t,e);return t};$.transformMat4=function(t,e,n){let r=e.x,a=e.y,s=e.z,i=e.w;t.x=n.m00*r+n.m04*a+n.m08*s+n.m12*i;t.y=n.m01*r+n.m05*a+n.m09*s+n.m13*i;t.z=n.m02*r+n.m06*a+n.m10*s+n.m14*i;t.w=n.m03*r+n.m07*a+n.m11*s+n.m15*i;return t};$.transformQuat=function(t,e,n){let r=e.x,a=e.y,s=e.z;let i=n.x,m=n.y,o=n.z,l=n.w;let u=l*r+m*s-o*a;let h=l*a+o*r-i*s;let f=l*s+i*a-m*r;let c=-i*r-m*a-o*s;t.x=u*l+c*-i+h*-o-f*-m;t.y=h*l+c*-m+f*-i-u*-o;t.z=f*l+c*-o+u*-m-h*-i;t.w=e.w;return t};$.forEach=function(){let t=$.create();return function(e,n,r,a,s,i){let m,o;if(!n){n=4}if(!r){r=0}if(a){o=Math.min(a*n+r,e.length)}else{o=e.length}for(m=r;m<o;m+=n){t.x=e[m];t.y=e[m+1];t.z=e[m+2];t.w=e[m+3];s(t,t,i);e[m]=t.x;e[m+1]=t.y;e[m+2]=t.z;e[m+3]=t.w}return e}}();$.str=function(t){return`vec4(${t.x}, ${t.y}, ${t.z}, ${t.w})`};$.array=function(t,e){t[0]=e.x;t[1]=e.y;t[2]=e.z;t[3]=e.w;return t};$.exactEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w};$.equals=function(t,e){let r=t.x,a=t.y,s=t.z,i=t.w;let m=e.x,o=e.y,l=e.z,u=e.w;return Math.abs(r-m)<=n*Math.max(1,Math.abs(r),Math.abs(m))&&Math.abs(a-o)<=n*Math.max(1,Math.abs(a),Math.abs(o))&&Math.abs(s-l)<=n*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(i-u)<=n*Math.max(1,Math.abs(i),Math.abs(u))};let G=new Array(9);class W{constructor(t,e,n,r,a,s,i,m,o){this.m00=t;this.m01=e;this.m02=n;this.m03=r;this.m04=a;this.m05=s;this.m06=i;this.m07=m;this.m08=o}toJSON(){G[0]=this.m00;G[1]=this.m01;G[2]=this.m02;G[3]=this.m03;G[4]=this.m04;G[5]=this.m05;G[6]=this.m06;G[7]=this.m07;G[8]=this.m08;return G}}let Y={};Y.create=function(){return new W(1,0,0,0,1,0,0,0,1)};Y.new=function(t,e,n,r,a,s,i,m,o){return new W(t,e,n,r,a,s,i,m,o)};Y.clone=function(t){return new W(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)};Y.copy=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;t.m04=e.m04;t.m05=e.m05;t.m06=e.m06;t.m07=e.m07;t.m08=e.m08;return t};Y.set=function(t,e,n,r,a,s,i,m,o,l){t.m00=e;t.m01=n;t.m02=r;t.m03=a;t.m04=s;t.m05=i;t.m06=m;t.m07=o;t.m08=l;return t};Y.identity=function(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Y.transpose=function(t,e){if(t===e){let n=e.m01,r=e.m02,a=e.m05;t.m01=e.m03;t.m02=e.m06;t.m03=n;t.m05=e.m07;t.m06=r;t.m07=a}else{t.m00=e.m00;t.m01=e.m03;t.m02=e.m06;t.m03=e.m01;t.m04=e.m04;t.m05=e.m07;t.m06=e.m02;t.m07=e.m05;t.m08=e.m08}return t};Y.invert=function(t,e){let n=e.m00,r=e.m01,a=e.m02,s=e.m03,i=e.m04,m=e.m05,o=e.m06,l=e.m07,u=e.m08;let h=u*i-m*l;let f=-u*s+m*o;let c=l*s-i*o;let _=n*h+r*f+a*c;if(!_){return null}_=1/_;t.m00=h*_;t.m01=(-u*r+a*l)*_;t.m02=(m*r-a*i)*_;t.m03=f*_;t.m04=(u*n-a*o)*_;t.m05=(-m*n+a*s)*_;t.m06=c*_;t.m07=(-l*n+r*o)*_;t.m08=(i*n-r*s)*_;return t};Y.adjoint=function(t,e){let n=e.m00,r=e.m01,a=e.m02,s=e.m03,i=e.m04,m=e.m05,o=e.m06,l=e.m07,u=e.m08;t.m00=i*u-m*l;t.m01=a*l-r*u;t.m02=r*m-a*i;t.m03=m*o-s*u;t.m04=n*u-a*o;t.m05=a*s-n*m;t.m06=s*l-i*o;t.m07=r*o-n*l;t.m08=n*i-r*s;return t};Y.determinant=function(t){let e=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,i=t.m05,m=t.m06,o=t.m07,l=t.m08;return e*(l*s-i*o)+n*(-l*a+i*m)+r*(o*a-s*m)};Y.multiply=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=e.m04,o=e.m05,l=e.m06,u=e.m07,h=e.m08;let f=n.m00,c=n.m01,_=n.m02;let d=n.m03,x=n.m04,g=n.m05;let p=n.m06,y=n.m07,M=n.m08;t.m00=f*r+c*i+_*l;t.m01=f*a+c*m+_*u;t.m02=f*s+c*o+_*h;t.m03=d*r+x*i+g*l;t.m04=d*a+x*m+g*u;t.m05=d*s+x*o+g*h;t.m06=p*r+y*i+M*l;t.m07=p*a+y*m+M*u;t.m08=p*s+y*o+M*h;return t};Y.mul=Y.multiply;Y.translate=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=e.m04,o=e.m05,l=e.m06,u=e.m07,h=e.m08;let f=n.x,c=n.y;t.m00=r;t.m01=a;t.m02=s;t.m03=i;t.m04=m;t.m05=o;t.m06=f*r+c*i+l;t.m07=f*a+c*m+u;t.m08=f*s+c*o+h;return t};Y.rotate=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=e.m04,o=e.m05,l=e.m06,u=e.m07,h=e.m08;let f=Math.sin(n);let c=Math.cos(n);t.m00=c*r+f*i;t.m01=c*a+f*m;t.m02=c*s+f*o;t.m03=c*i-f*r;t.m04=c*m-f*a;t.m05=c*o-f*s;t.m06=l;t.m07=u;t.m08=h;return t};Y.scale=function(t,e,n){let r=n.x,a=n.y;t.m00=r*e.m00;t.m01=r*e.m01;t.m02=r*e.m02;t.m03=a*e.m03;t.m04=a*e.m04;t.m05=a*e.m05;t.m06=e.m06;t.m07=e.m07;t.m08=e.m08;return t};Y.fromMat4=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m04;t.m04=e.m05;t.m05=e.m06;t.m06=e.m08;t.m07=e.m09;t.m08=e.m10;return t};Y.fromTranslation=function(t,e){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=1;t.m05=0;t.m06=e.x;t.m07=e.y;t.m08=1;return t};Y.fromRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=n;t.m02=0;t.m03=-n;t.m04=r;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Y.fromScaling=function(t,e){t.m00=e.x;t.m01=0;t.m02=0;t.m03=0;t.m04=e.y;t.m05=0;t.m06=0;t.m07=0;t.m08=1;return t};Y.fromMat2d=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=0;t.m03=e.m02;t.m04=e.m03;t.m05=0;t.m06=e.m04;t.m07=e.m05;t.m08=1;return t};Y.fromQuat=function(t,e){let n=e.x,r=e.y,a=e.z,s=e.w;let i=n+n;let m=r+r;let o=a+a;let l=n*i;let u=r*i;let h=r*m;let f=a*i;let c=a*m;let _=a*o;let d=s*i;let x=s*m;let g=s*o;t.m00=1-h-_;t.m03=u-g;t.m06=f+x;t.m01=u+g;t.m04=1-l-_;t.m07=c-d;t.m02=f-x;t.m05=c+d;t.m08=1-l-h;return t};Y.fromViewUp=function(){let t=k.new(0,1,0);let e=k.create();let r=k.create();return function(a,s,i){if(k.sqrLen(s)<n*n){Y.identity(a);return a}i=i||t;k.cross(e,i,s);if(k.sqrLen(e)<n*n){Y.identity(a);return a}k.cross(r,s,e);Y.set(a,e.x,e.y,e.z,r.x,r.y,r.z,s.x,s.y,s.z);return a}}();Y.normalFromMat4=function(t,e){let n=e.m00,r=e.m01,a=e.m02,s=e.m03,i=e.m04,m=e.m05,o=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,c=e.m11,_=e.m12,d=e.m13,x=e.m14,g=e.m15;let p=n*m-r*i;let y=n*o-a*i;let M=n*l-s*i;let w=r*o-a*m;let A=r*l-s*m;let v=a*l-s*o;let S=u*d-h*_;let b=u*x-f*_;let E=u*g-c*_;let z=h*x-f*d;let T=h*g-c*d;let P=f*g-c*x;let R=p*P-y*T+M*z+w*E-A*b+v*S;if(!R){return null}R=1/R;t.m00=(m*P-o*T+l*z)*R;t.m01=(o*E-i*P-l*b)*R;t.m02=(i*T-m*E+l*S)*R;t.m03=(a*T-r*P-s*z)*R;t.m04=(n*P-a*E+s*b)*R;t.m05=(r*E-n*T-s*S)*R;t.m06=(d*v-x*A+g*w)*R;t.m07=(x*M-_*v-g*y)*R;t.m08=(_*A-d*M+g*p)*R;return t};Y.str=function(t){return`mat3(${t.m00}, ${t.m01}, ${t.m02}, ${t.m03}, ${t.m04}, ${t.m05}, ${t.m06}, ${t.m07}, ${t.m08})`};Y.array=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=e.m02;t[3]=e.m03;t[4]=e.m04;t[5]=e.m05;t[6]=e.m06;t[7]=e.m07;t[8]=e.m08;return t};Y.frob=function(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2))};Y.add=function(t,e,n){t.m00=e.m00+n.m00;t.m01=e.m01+n.m01;t.m02=e.m02+n.m02;t.m03=e.m03+n.m03;t.m04=e.m04+n.m04;t.m05=e.m05+n.m05;t.m06=e.m06+n.m06;t.m07=e.m07+n.m07;t.m08=e.m08+n.m08;return t};Y.subtract=function(t,e,n){t.m00=e.m00-n.m00;t.m01=e.m01-n.m01;t.m02=e.m02-n.m02;t.m03=e.m03-n.m03;t.m04=e.m04-n.m04;t.m05=e.m05-n.m05;t.m06=e.m06-n.m06;t.m07=e.m07-n.m07;t.m08=e.m08-n.m08;return t};Y.sub=Y.subtract;Y.multiplyScalar=function(t,e,n){t.m00=e.m00*n;t.m01=e.m01*n;t.m02=e.m02*n;t.m03=e.m03*n;t.m04=e.m04*n;t.m05=e.m05*n;t.m06=e.m06*n;t.m07=e.m07*n;t.m08=e.m08*n;return t};Y.multiplyScalarAndAdd=function(t,e,n,r){t.m00=e.m00+n.m00*r;t.m01=e.m01+n.m01*r;t.m02=e.m02+n.m02*r;t.m03=e.m03+n.m03*r;t.m04=e.m04+n.m04*r;t.m05=e.m05+n.m05*r;t.m06=e.m06+n.m06*r;t.m07=e.m07+n.m07*r;t.m08=e.m08+n.m08*r;return t};Y.exactEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08};Y.equals=function(t,e){let r=t.m00,a=t.m01,s=t.m02,i=t.m03,m=t.m04,o=t.m05,l=t.m06,u=t.m07,h=t.m08;let f=e.m00,c=e.m01,_=e.m02,d=e.m03,x=e.m04,g=e.m05,p=e.m06,y=e.m07,M=e.m08;return Math.abs(r-f)<=n*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(a-c)<=n*Math.max(1,Math.abs(a),Math.abs(c))&&Math.abs(s-_)<=n*Math.max(1,Math.abs(s),Math.abs(_))&&Math.abs(i-d)<=n*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(m-x)<=n*Math.max(1,Math.abs(m),Math.abs(x))&&Math.abs(o-g)<=n*Math.max(1,Math.abs(o),Math.abs(g))&&Math.abs(l-p)<=n*Math.max(1,Math.abs(l),Math.abs(p))&&Math.abs(u-y)<=n*Math.max(1,Math.abs(u),Math.abs(y))&&Math.abs(h-M)<=n*Math.max(1,Math.abs(h),Math.abs(M))};let X=new Array(4);class Z{constructor(t,e,n,r){this.x=t;this.y=e;this.z=n;this.w=r}toJSON(){X[0]=this.x;X[1]=this.y;X[2]=this.z;X[3]=this.w;return X}}let J={};J.create=function(){return new Z(0,0,0,1)};J.new=function(t,e,n,r){return new Z(t,e,n,r)};J.clone=function(t){return new Z(t.x,t.y,t.z,t.w)};J.copy=$.copy;J.set=$.set;J.identity=function(t){t.x=0;t.y=0;t.z=0;t.w=1;return t};J.rotationTo=function(){let t=k.create();let e=k.new(1,0,0);let n=k.new(0,1,0);return function(r,a,s){let i=k.dot(a,s);if(i<-.999999){k.cross(t,e,a);if(k.length(t)<1e-6){k.cross(t,n,a)}k.normalize(t,t);J.fromAxisAngle(r,t,Math.PI);return r}else if(i>.999999){r.x=0;r.y=0;r.z=0;r.w=1;return r}else{k.cross(t,a,s);r.x=t.x;r.y=t.y;r.z=t.z;r.w=1+i;return J.normalize(r,r)}}}();J.getAxisAngle=function(t,e){let n=Math.acos(e.w)*2;let r=Math.sin(n/2);if(r!=0){t.x=e.x/r;t.y=e.y/r;t.z=e.z/r}else{t.x=1;t.y=0;t.z=0}return n};J.multiply=function(t,e,n){let r=e.x,a=e.y,s=e.z,i=e.w,m=n.x,o=n.y,l=n.z,u=n.w;t.x=r*u+i*m+a*l-s*o;t.y=a*u+i*o+s*m-r*l;t.z=s*u+i*l+r*o-a*m;t.w=i*u-r*m-a*o-s*l;return t};J.mul=J.multiply;J.scale=$.scale;J.rotateX=function(t,e,n){n*=.5;let r=e.x,a=e.y,s=e.z,i=e.w,m=Math.sin(n),o=Math.cos(n);t.x=r*o+i*m;t.y=a*o+s*m;t.z=s*o-a*m;t.w=i*o-r*m;return t};J.rotateY=function(t,e,n){n*=.5;let r=e.x,a=e.y,s=e.z,i=e.w,m=Math.sin(n),o=Math.cos(n);t.x=r*o-s*m;t.y=a*o+i*m;t.z=s*o+r*m;t.w=i*o-a*m;return t};J.rotateZ=function(t,e,n){n*=.5;let r=e.x,a=e.y,s=e.z,i=e.w,m=Math.sin(n),o=Math.cos(n);t.x=r*o+a*m;t.y=a*o-r*m;t.z=s*o+i*m;t.w=i*o-s*m;return t};J.rotateAround=function(){let t=k.create();let e=J.create();return function(n,r,a,s){J.invert(e,r);k.transformQuat(t,a,e);J.fromAxisAngle(e,t,s);J.mul(n,r,e);return n}}();J.rotateAroundLocal=function(){let t=J.create();return function(e,n,r,a){J.fromAxisAngle(t,r,a);J.mul(e,n,t);return e}}();J.calculateW=function(t,e){let n=e.x,r=e.y,a=e.z;t.x=n;t.y=r;t.z=a;t.w=Math.sqrt(Math.abs(1-n*n-r*r-a*a));return t};J.dot=$.dot;J.lerp=$.lerp;J.slerp=function(t,e,n,r){let a=e.x,s=e.y,i=e.z,m=e.w,o=n.x,l=n.y,u=n.z,h=n.w;let f,c,_,d,x;c=a*o+s*l+i*u+m*h;if(c<0){c=-c;o=-o;l=-l;u=-u;h=-h}if(1-c>1e-6){f=Math.acos(c);_=Math.sin(f);d=Math.sin((1-r)*f)/_;x=Math.sin(r*f)/_}else{d=1-r;x=r}t.x=d*a+x*o;t.y=d*s+x*l;t.z=d*i+x*u;t.w=d*m+x*h;return t};J.sqlerp=function(){let t=J.create();let e=J.create();return function(n,r,a,s,i,m){J.slerp(t,r,i,m);J.slerp(e,a,s,m);J.slerp(n,t,e,2*m*(1-m));return n}}();J.invert=function(t,e){let n=e.x,r=e.y,a=e.z,s=e.w;let i=n*n+r*r+a*a+s*s;let m=i?1/i:0;t.x=-n*m;t.y=-r*m;t.z=-a*m;t.w=s*m;return t};J.conjugate=function(t,e){t.x=-e.x;t.y=-e.y;t.z=-e.z;t.w=e.w;return t};J.length=$.length;J.len=J.length;J.squaredLength=$.squaredLength;J.sqrLen=J.squaredLength;J.normalize=$.normalize;J.fromAxes=function(){let t=Y.create();return function(e,n,r,a){Y.set(t,n.x,n.y,n.z,r.x,r.y,r.z,a.x,a.y,a.z);return J.normalize(e,J.fromMat3(e,t))}}();J.fromViewUp=function(){let t=Y.create();return function(e,n,r){Y.fromViewUp(t,n,r);if(!t){return null}return J.normalize(e,J.fromMat3(e,t))}}();J.fromAxisAngle=function(t,e,n){n=n*.5;let r=Math.sin(n);t.x=r*e.x;t.y=r*e.y;t.z=r*e.z;t.w=Math.cos(n);return t};J.fromMat3=function(t,e){let n=e.m00,r=e.m03,a=e.m06,s=e.m01,i=e.m04,m=e.m07,o=e.m02,l=e.m05,u=e.m08;let h=n+i+u;if(h>0){let e=.5/Math.sqrt(h+1);t.w=.25/e;t.x=(l-m)*e;t.y=(a-o)*e;t.z=(s-r)*e}else if(n>i&&n>u){let e=2*Math.sqrt(1+n-i-u);t.w=(l-m)/e;t.x=.25*e;t.y=(r+s)/e;t.z=(a+o)/e}else if(i>u){let e=2*Math.sqrt(1+i-n-u);t.w=(a-o)/e;t.x=(r+s)/e;t.y=.25*e;t.z=(m+l)/e}else{let e=2*Math.sqrt(1+u-n-i);t.w=(s-r)/e;t.x=(a+o)/e;t.y=(m+l)/e;t.z=.25*e}return t};J.fromEuler=function(t,e,n,r){let a=.5*Math.PI/180;e*=a;n*=a;r*=a;let s=Math.sin(e);let i=Math.cos(e);let m=Math.sin(n);let o=Math.cos(n);let l=Math.sin(r);let u=Math.cos(r);t.x=s*o*u-i*m*l;t.y=i*m*u+s*o*l;t.z=i*o*l-s*m*u;t.w=i*o*u+s*m*l;return t};J.str=function(t){return`quat(${t.x}, ${t.y}, ${t.z}, ${t.w})`};J.array=function(t,e){t[0]=e.x;t[1]=e.y;t[2]=e.z;t[3]=e.w;return t};J.exactEquals=$.exactEquals;J.equals=$.equals;let K=new Array(4);class Q{constructor(t,e,n,r){this.m00=t;this.m01=e;this.m02=n;this.m03=r}toJSON(){K[0]=this.m00;K[1]=this.m01;K[2]=this.m02;K[3]=this.m03;return K}}let tt={};tt.create=function(){return new Q(1,0,0,1)};tt.new=function(t,e,n,r){return new Q(t,e,n,r)};tt.clone=function(t){return new Q(t.m00,t.m01,t.m02,t.m03)};tt.copy=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;return t};tt.identity=function(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;return t};tt.set=function(t,e,n,r,a){t.m00=e;t.m01=n;t.m02=r;t.m03=a;return t};tt.transpose=function(t,e){if(t===e){let n=e.m01;t.m01=e.m02;t.m02=n}else{t.m00=e.m00;t.m01=e.m02;t.m02=e.m01;t.m03=e.m03}return t};tt.invert=function(t,e){let n=e.m00,r=e.m01,a=e.m02,s=e.m03;let i=n*s-a*r;if(!i){return null}i=1/i;t.m00=s*i;t.m01=-r*i;t.m02=-a*i;t.m03=n*i;return t};tt.adjoint=function(t,e){let n=e.m00;t.m00=e.m03;t.m01=-e.m01;t.m02=-e.m02;t.m03=n;return t};tt.determinant=function(t){return t.m00*t.m03-t.m02*t.m01};tt.multiply=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03;let m=n.m00,o=n.m01,l=n.m02,u=n.m03;t.m00=r*m+s*o;t.m01=a*m+i*o;t.m02=r*l+s*u;t.m03=a*l+i*u;return t};tt.mul=tt.multiply;tt.rotate=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=Math.sin(n),o=Math.cos(n);t.m00=r*o+s*m;t.m01=a*o+i*m;t.m02=r*-m+s*o;t.m03=a*-m+i*o;return t};tt.scale=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=n.x,o=n.y;t.m00=r*m;t.m01=a*m;t.m02=s*o;t.m03=i*o;return t};tt.fromRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=n;t.m02=-n;t.m03=r;return t};tt.fromScaling=function(t,e){t.m00=e.x;t.m01=0;t.m02=0;t.m03=e.y;return t};tt.str=function(t){return`mat2(${t.m00}, ${t.m01}, ${t.m02}, ${t.m03})`};tt.array=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=e.m02;t[3]=e.m03;return t};tt.frob=function(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2))};tt.LDU=function(t,e,n,r){t.m02=r.m02/r.m00;n.m00=r.m00;n.m01=r.m01;n.m03=r.m03-t.m02*n.m01};tt.add=function(t,e,n){t.m00=e.m00+n.m00;t.m01=e.m01+n.m01;t.m02=e.m02+n.m02;t.m03=e.m03+n.m03;return t};tt.subtract=function(t,e,n){t.m00=e.m00-n.m00;t.m01=e.m01-n.m01;t.m02=e.m02-n.m02;t.m03=e.m03-n.m03;return t};tt.sub=tt.subtract;tt.exactEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03};tt.equals=function(t,e){let r=t.m00,a=t.m01,s=t.m02,i=t.m03;let m=e.m00,o=e.m01,l=e.m02,u=e.m03;return Math.abs(r-m)<=n*Math.max(1,Math.abs(r),Math.abs(m))&&Math.abs(a-o)<=n*Math.max(1,Math.abs(a),Math.abs(o))&&Math.abs(s-l)<=n*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(i-u)<=n*Math.max(1,Math.abs(i),Math.abs(u))};tt.multiplyScalar=function(t,e,n){t.m00=e.m00*n;t.m01=e.m01*n;t.m02=e.m02*n;t.m03=e.m03*n;return t};tt.multiplyScalarAndAdd=function(t,e,n,r){t.m00=e.m00+n.m00*r;t.m01=e.m01+n.m01*r;t.m02=e.m02+n.m02*r;t.m03=e.m03+n.m03*r;return t};let et=new Array(6);class nt{constructor(t,e,n,r,a,s){this.m00=t;this.m01=e;this.m02=n;this.m03=r;this.m04=a;this.m05=s}toJSON(){et[0]=this.m00;et[1]=this.m01;et[2]=this.m02;et[3]=this.m03;et[4]=this.m04;et[5]=this.m05;return et}}let rt={};rt.create=function(){return new nt(1,0,0,1,0,0)};rt.new=function(t,e,n,r,a,s){return new nt(t,e,n,r,a,s)};rt.clone=function(t){return new nt(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05)};rt.copy=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;t.m04=e.m04;t.m05=e.m05;return t};rt.identity=function(t){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=0;t.m05=0;return t};rt.set=function(t,e,n,r,a,s,i){t.m00=e;t.m01=n;t.m02=r;t.m03=a;t.m04=s;t.m05=i;return t};rt.invert=function(t,e){let n=e.m00,r=e.m01,a=e.m02,s=e.m03,i=e.m04,m=e.m05;let o=n*s-r*a;if(!o){return null}o=1/o;t.m00=s*o;t.m01=-r*o;t.m02=-a*o;t.m03=n*o;t.m04=(a*m-s*i)*o;t.m05=(r*i-n*m)*o;return t};rt.determinant=function(t){return t.m00*t.m03-t.m01*t.m02};rt.multiply=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=e.m04,o=e.m05,l=n.m00,u=n.m01,h=n.m02,f=n.m03,c=n.m04,_=n.m05;t.m00=r*l+s*u;t.m01=a*l+i*u;t.m02=r*h+s*f;t.m03=a*h+i*f;t.m04=r*c+s*_+m;t.m05=a*c+i*_+o;return t};rt.mul=rt.multiply;rt.rotate=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=e.m04,o=e.m05,l=Math.sin(n),u=Math.cos(n);t.m00=r*u+s*l;t.m01=a*u+i*l;t.m02=r*-l+s*u;t.m03=a*-l+i*u;t.m04=m;t.m05=o;return t};rt.scale=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=e.m04,o=e.m05,l=n.x,u=n.y;t.m00=r*l;t.m01=a*l;t.m02=s*u;t.m03=i*u;t.m04=m;t.m05=o;return t};rt.translate=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=e.m04,o=e.m05,l=n.x,u=n.y;t.m00=r;t.m01=a;t.m02=s;t.m03=i;t.m04=r*l+s*u+m;t.m05=a*l+i*u+o;return t};rt.fromRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=n;t.m02=-n;t.m03=r;t.m04=0;t.m05=0;return t};rt.fromScaling=function(t,e){t.m00=e.m00;t.m01=0;t.m02=0;t.m03=e.m01;t.m04=0;t.m05=0;return t};rt.fromTranslation=function(t,e){t.m00=1;t.m01=0;t.m02=0;t.m03=1;t.m04=e.x;t.m05=e.y;return t};rt.str=function(t){return`mat23(${t.m00}, ${t.m01}, ${t.m02}, ${t.m03}, ${t.m04}, ${t.m05})`};rt.array=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=e.m02;t[3]=e.m03;t[4]=e.m04;t[5]=e.m05;return t};rt.array4x4=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=0;t[3]=0;t[4]=e.m02;t[5]=e.m03;t[6]=0;t[7]=0;t[8]=0;t[9]=0;t[10]=1;t[11]=0;t[12]=e.m04;t[13]=e.m05;t[14]=0;t[15]=1;return t};rt.frob=function(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+1)};rt.add=function(t,e,n){t.m00=e.m00+n.m00;t.m01=e.m01+n.m01;t.m02=e.m02+n.m02;t.m03=e.m03+n.m03;t.m04=e.m04+n.m04;t.m05=e.m05+n.m05;return t};rt.subtract=function(t,e,n){t.m00=e.m00-n.m00;t.m01=e.m01-n.m01;t.m02=e.m02-n.m02;t.m03=e.m03-n.m03;t.m04=e.m04-n.m04;t.m05=e.m05-n.m05;return t};rt.sub=rt.subtract;rt.multiplyScalar=function(t,e,n){t.m00=e.m00*n;t.m01=e.m01*n;t.m02=e.m02*n;t.m03=e.m03*n;t.m04=e.m04*n;t.m05=e.m05*n;return t};rt.multiplyScalarAndAdd=function(t,e,n,r){t.m00=e.m00+n.m00*r;t.m01=e.m01+n.m01*r;t.m02=e.m02+n.m02*r;t.m03=e.m03+n.m03*r;t.m04=e.m04+n.m04*r;t.m05=e.m05+n.m05*r;return t};rt.exactEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05};rt.equals=function(t,e){let r=t.m00,a=t.m01,s=t.m02,i=t.m03,m=t.m04,o=t.m05;let l=e.m00,u=e.m01,h=e.m02,f=e.m03,c=e.m04,_=e.m05;return Math.abs(r-l)<=n*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(a-u)<=n*Math.max(1,Math.abs(a),Math.abs(u))&&Math.abs(s-h)<=n*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(i-f)<=n*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(m-c)<=n*Math.max(1,Math.abs(m),Math.abs(c))&&Math.abs(o-_)<=n*Math.max(1,Math.abs(o),Math.abs(_))};let at=new Array(16);class st{constructor(t,e,n,r,a,s,i,m,o,l,u,h,f,c,_,d){this.m00=t;this.m01=e;this.m02=n;this.m03=r;this.m04=a;this.m05=s;this.m06=i;this.m07=m;this.m08=o;this.m09=l;this.m10=u;this.m11=h;this.m12=f;this.m13=c;this.m14=_;this.m15=d}toJSON(){at[0]=this.m00;at[1]=this.m01;at[2]=this.m02;at[3]=this.m03;at[4]=this.m04;at[5]=this.m05;at[6]=this.m06;at[7]=this.m07;at[8]=this.m08;at[9]=this.m09;at[10]=this.m10;at[11]=this.m11;at[12]=this.m12;at[13]=this.m13;at[14]=this.m14;at[15]=this.m15;return at}}let it={};it.create=function(){return new st(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)};it.new=function(t,e,n,r,a,s,i,m,o,l,u,h,f,c,_,d){return new st(t,e,n,r,a,s,i,m,o,l,u,h,f,c,_,d)};it.clone=function(t){return new st(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)};it.copy=function(t,e){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;t.m04=e.m04;t.m05=e.m05;t.m06=e.m06;t.m07=e.m07;t.m08=e.m08;t.m09=e.m09;t.m10=e.m10;t.m11=e.m11;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15;return t};it.set=function(t,e,n,r,a,s,i,m,o,l,u,h,f,c,_,d,x){t.m00=e;t.m01=n;t.m02=r;t.m03=a;t.m04=s;t.m05=i;t.m06=m;t.m07=o;t.m08=l;t.m09=u;t.m10=h;t.m11=f;t.m12=c;t.m13=_;t.m14=d;t.m15=x;return t};it.identity=function(t){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};it.transpose=function(t,e){if(t===e){let n=e.m01,r=e.m02,a=e.m03,s=e.m06,i=e.m07,m=e.m11;t.m01=e.m04;t.m02=e.m08;t.m03=e.m12;t.m04=n;t.m06=e.m09;t.m07=e.m13;t.m08=r;t.m09=s;t.m11=e.m14;t.m12=a;t.m13=i;t.m14=m}else{t.m00=e.m00;t.m01=e.m04;t.m02=e.m08;t.m03=e.m12;t.m04=e.m01;t.m05=e.m05;t.m06=e.m09;t.m07=e.m13;t.m08=e.m02;t.m09=e.m06;t.m10=e.m10;t.m11=e.m14;t.m12=e.m03;t.m13=e.m07;t.m14=e.m11;t.m15=e.m15}return t};it.invert=function(t,e){let n=e.m00,r=e.m01,a=e.m02,s=e.m03,i=e.m04,m=e.m05,o=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,c=e.m11,_=e.m12,d=e.m13,x=e.m14,g=e.m15;let p=n*m-r*i;let y=n*o-a*i;let M=n*l-s*i;let w=r*o-a*m;let A=r*l-s*m;let v=a*l-s*o;let S=u*d-h*_;let b=u*x-f*_;let E=u*g-c*_;let z=h*x-f*d;let T=h*g-c*d;let P=f*g-c*x;let R=p*P-y*T+M*z+w*E-A*b+v*S;if(!R){return null}R=1/R;t.m00=(m*P-o*T+l*z)*R;t.m01=(a*T-r*P-s*z)*R;t.m02=(d*v-x*A+g*w)*R;t.m03=(f*A-h*v-c*w)*R;t.m04=(o*E-i*P-l*b)*R;t.m05=(n*P-a*E+s*b)*R;t.m06=(x*M-_*v-g*y)*R;t.m07=(u*v-f*M+c*y)*R;t.m08=(i*T-m*E+l*S)*R;t.m09=(r*E-n*T-s*S)*R;t.m10=(_*A-d*M+g*p)*R;t.m11=(h*M-u*A-c*p)*R;t.m12=(m*b-i*z-o*S)*R;t.m13=(n*z-r*b+a*S)*R;t.m14=(d*y-_*w-x*p)*R;t.m15=(u*w-h*y+f*p)*R;return t};it.adjoint=function(t,e){let n=e.m00,r=e.m01,a=e.m02,s=e.m03,i=e.m04,m=e.m05,o=e.m06,l=e.m07,u=e.m08,h=e.m09,f=e.m10,c=e.m11,_=e.m12,d=e.m13,x=e.m14,g=e.m15;t.m00=m*(f*g-c*x)-h*(o*g-l*x)+d*(o*c-l*f);t.m01=-(r*(f*g-c*x)-h*(a*g-s*x)+d*(a*c-s*f));t.m02=r*(o*g-l*x)-m*(a*g-s*x)+d*(a*l-s*o);t.m03=-(r*(o*c-l*f)-m*(a*c-s*f)+h*(a*l-s*o));t.m04=-(i*(f*g-c*x)-u*(o*g-l*x)+_*(o*c-l*f));t.m05=n*(f*g-c*x)-u*(a*g-s*x)+_*(a*c-s*f);t.m06=-(n*(o*g-l*x)-i*(a*g-s*x)+_*(a*l-s*o));t.m07=n*(o*c-l*f)-i*(a*c-s*f)+u*(a*l-s*o);t.m08=i*(h*g-c*d)-u*(m*g-l*d)+_*(m*c-l*h);t.m09=-(n*(h*g-c*d)-u*(r*g-s*d)+_*(r*c-s*h));t.m10=n*(m*g-l*d)-i*(r*g-s*d)+_*(r*l-s*m);t.m11=-(n*(m*c-l*h)-i*(r*c-s*h)+u*(r*l-s*m));t.m12=-(i*(h*x-f*d)-u*(m*x-o*d)+_*(m*f-o*h));t.m13=n*(h*x-f*d)-u*(r*x-a*d)+_*(r*f-a*h);t.m14=-(n*(m*x-o*d)-i*(r*x-a*d)+_*(r*o-a*m));t.m15=n*(m*f-o*h)-i*(r*f-a*h)+u*(r*o-a*m);return t};it.determinant=function(t){let e=t.m00,n=t.m01,r=t.m02,a=t.m03,s=t.m04,i=t.m05,m=t.m06,o=t.m07,l=t.m08,u=t.m09,h=t.m10,f=t.m11,c=t.m12,_=t.m13,d=t.m14,x=t.m15;let g=e*i-n*s;let p=e*m-r*s;let y=e*o-a*s;let M=n*m-r*i;let w=n*o-a*i;let A=r*o-a*m;let v=l*_-u*c;let S=l*d-h*c;let b=l*x-f*c;let E=u*d-h*_;let z=u*x-f*_;let T=h*x-f*d;return g*T-p*z+y*E+M*b-w*S+A*v};it.multiply=function(t,e,n){let r=e.m00,a=e.m01,s=e.m02,i=e.m03,m=e.m04,o=e.m05,l=e.m06,u=e.m07,h=e.m08,f=e.m09,c=e.m10,_=e.m11,d=e.m12,x=e.m13,g=e.m14,p=e.m15;let y=n.m00,M=n.m01,w=n.m02,A=n.m03;t.m00=y*r+M*m+w*h+A*d;t.m01=y*a+M*o+w*f+A*x;t.m02=y*s+M*l+w*c+A*g;t.m03=y*i+M*u+w*_+A*p;y=n.m04;M=n.m05;w=n.m06;A=n.m07;t.m04=y*r+M*m+w*h+A*d;t.m05=y*a+M*o+w*f+A*x;t.m06=y*s+M*l+w*c+A*g;t.m07=y*i+M*u+w*_+A*p;y=n.m08;M=n.m09;w=n.m10;A=n.m11;t.m08=y*r+M*m+w*h+A*d;t.m09=y*a+M*o+w*f+A*x;t.m10=y*s+M*l+w*c+A*g;t.m11=y*i+M*u+w*_+A*p;y=n.m12;M=n.m13;w=n.m14;A=n.m15;t.m12=y*r+M*m+w*h+A*d;t.m13=y*a+M*o+w*f+A*x;t.m14=y*s+M*l+w*c+A*g;t.m15=y*i+M*u+w*_+A*p;return t};it.mul=it.multiply;it.translate=function(t,e,n){let r=n.x,a=n.y,s=n.z,i,m,o,l,u,h,f,c,_,d,x,g;if(e===t){t.m12=e.m00*r+e.m04*a+e.m08*s+e.m12;t.m13=e.m01*r+e.m05*a+e.m09*s+e.m13;t.m14=e.m02*r+e.m06*a+e.m10*s+e.m14;t.m15=e.m03*r+e.m07*a+e.m11*s+e.m15}else{i=e.m00;m=e.m01;o=e.m02;l=e.m03;u=e.m04;h=e.m05;f=e.m06;c=e.m07;_=e.m08;d=e.m09;x=e.m10;g=e.m11;t.m00=i;t.m01=m;t.m02=o;t.m03=l;t.m04=u;t.m05=h;t.m06=f;t.m07=c;t.m08=_;t.m09=d;t.m10=x;t.m11=g;t.m12=i*r+u*a+_*s+e.m12;t.m13=m*r+h*a+d*s+e.m13;t.m14=o*r+f*a+x*s+e.m14;t.m15=l*r+c*a+g*s+e.m15}return t};it.scale=function(t,e,n){let r=n.x,a=n.y,s=n.z;t.m00=e.m00*r;t.m01=e.m01*r;t.m02=e.m02*r;t.m03=e.m03*r;t.m04=e.m04*a;t.m05=e.m05*a;t.m06=e.m06*a;t.m07=e.m07*a;t.m08=e.m08*s;t.m09=e.m09*s;t.m10=e.m10*s;t.m11=e.m11*s;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15;return t};it.rotate=function(t,e,r,a){let s=a.x,i=a.y,m=a.z;let o,l,u,h,f,c,_,d,x,g,p,y,M,w,A,v,S,b,E,z,T,P,R,L;let C=Math.sqrt(s*s+i*i+m*m);if(Math.abs(C)<n){return null}C=1/C;s*=C;i*=C;m*=C;o=Math.sin(r);l=Math.cos(r);u=1-l;h=e.m00;f=e.m01;c=e.m02;_=e.m03;d=e.m04;x=e.m05;g=e.m06;p=e.m07;y=e.m08;M=e.m09;w=e.m10;A=e.m11;v=s*s*u+l;S=i*s*u+m*o;b=m*s*u-i*o;E=s*i*u-m*o;z=i*i*u+l;T=m*i*u+s*o;P=s*m*u+i*o;R=i*m*u-s*o;L=m*m*u+l;t.m00=h*v+d*S+y*b;t.m01=f*v+x*S+M*b;t.m02=c*v+g*S+w*b;t.m03=_*v+p*S+A*b;t.m04=h*E+d*z+y*T;t.m05=f*E+x*z+M*T;t.m06=c*E+g*z+w*T;t.m07=_*E+p*z+A*T;t.m08=h*P+d*R+y*L;t.m09=f*P+x*R+M*L;t.m10=c*P+g*R+w*L;t.m11=_*P+p*R+A*L;if(e!==t){t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15}return t};it.rotateX=function(t,e,n){let r=Math.sin(n),a=Math.cos(n),s=e.m04,i=e.m05,m=e.m06,o=e.m07,l=e.m08,u=e.m09,h=e.m10,f=e.m11;if(e!==t){t.m00=e.m00;t.m01=e.m01;t.m02=e.m02;t.m03=e.m03;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15}t.m04=s*a+l*r;t.m05=i*a+u*r;t.m06=m*a+h*r;t.m07=o*a+f*r;t.m08=l*a-s*r;t.m09=u*a-i*r;t.m10=h*a-m*r;t.m11=f*a-o*r;return t};it.rotateY=function(t,e,n){let r=Math.sin(n),a=Math.cos(n),s=e.m00,i=e.m01,m=e.m02,o=e.m03,l=e.m08,u=e.m09,h=e.m10,f=e.m11;if(e!==t){t.m04=e.m04;t.m05=e.m05;t.m06=e.m06;t.m07=e.m07;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15}t.m00=s*a-l*r;t.m01=i*a-u*r;t.m02=m*a-h*r;t.m03=o*a-f*r;t.m08=s*r+l*a;t.m09=i*r+u*a;t.m10=m*r+h*a;t.m11=o*r+f*a;return t};it.rotateZ=function(t,e,n){let r=Math.sin(n),a=Math.cos(n),s=e.m00,i=e.m01,m=e.m02,o=e.m03,l=e.m04,u=e.m05,h=e.m06,f=e.m07;if(e!==t){t.m08=e.m08;t.m09=e.m09;t.m10=e.m10;t.m11=e.m11;t.m12=e.m12;t.m13=e.m13;t.m14=e.m14;t.m15=e.m15}t.m00=s*a+l*r;t.m01=i*a+u*r;t.m02=m*a+h*r;t.m03=o*a+f*r;t.m04=l*a-s*r;t.m05=u*a-i*r;t.m06=h*a-m*r;t.m07=f*a-o*r;return t};it.fromTranslation=function(t,e){t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=e.x;t.m13=e.y;t.m14=e.z;t.m15=1;return t};it.fromScaling=function(t,e){t.m00=e.x;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=e.y;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=e.z;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};it.fromRotation=function(t,e,r){let a=r.x,s=r.y,i=r.z;let m=Math.sqrt(a*a+s*s+i*i);let o,l,u;if(Math.abs(m)<n){return null}m=1/m;a*=m;s*=m;i*=m;o=Math.sin(e);l=Math.cos(e);u=1-l;t.m00=a*a*u+l;t.m01=s*a*u+i*o;t.m02=i*a*u-s*o;t.m03=0;t.m04=a*s*u-i*o;t.m05=s*s*u+l;t.m06=i*s*u+a*o;t.m07=0;t.m08=a*i*u+s*o;t.m09=s*i*u-a*o;t.m10=i*i*u+l;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};it.fromXRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=1;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=r;t.m06=n;t.m07=0;t.m08=0;t.m09=-n;t.m10=r;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};it.fromYRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=0;t.m02=-n;t.m03=0;t.m04=0;t.m05=1;t.m06=0;t.m07=0;t.m08=n;t.m09=0;t.m10=r;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};it.fromZRotation=function(t,e){let n=Math.sin(e),r=Math.cos(e);t.m00=r;t.m01=n;t.m02=0;t.m03=0;t.m04=-n;t.m05=r;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=1;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};it.fromRT=function(t,e,n){let r=e.x,a=e.y,s=e.z,i=e.w;let m=r+r;let o=a+a;let l=s+s;let u=r*m;let h=r*o;let f=r*l;let c=a*o;let _=a*l;let d=s*l;let x=i*m;let g=i*o;let p=i*l;t.m00=1-(c+d);t.m01=h+p;t.m02=f-g;t.m03=0;t.m04=h-p;t.m05=1-(u+d);t.m06=_+x;t.m07=0;t.m08=f+g;t.m09=_-x;t.m10=1-(u+c);t.m11=0;t.m12=n.x;t.m13=n.y;t.m14=n.z;t.m15=1;return t};it.getTranslation=function(t,e){t.x=e.m12;t.y=e.m13;t.z=e.m14;return t};it.getScaling=function(t,e){let n=e.m00,r=e.m01,a=e.m02,s=e.m04,i=e.m05,m=e.m06,o=e.m08,l=e.m09,u=e.m10;t.x=Math.sqrt(n*n+r*r+a*a);t.y=Math.sqrt(s*s+i*i+m*m);t.z=Math.sqrt(o*o+l*l+u*u);return t};it.getRotation=function(t,e){let n=e.m00+e.m05+e.m10;let r=0;if(n>0){r=Math.sqrt(n+1)*2;t.w=.25*r;t.x=(e.m06-e.m09)/r;t.y=(e.m08-e.m02)/r;t.z=(e.m01-e.m04)/r}else if(e.m00>e.m05&e.m00>e.m10){r=Math.sqrt(1+e.m00-e.m05-e.m10)*2;t.w=(e.m06-e.m09)/r;t.x=.25*r;t.y=(e.m01+e.m04)/r;t.z=(e.m08+e.m02)/r}else if(e.m05>e.m10){r=Math.sqrt(1+e.m05-e.m00-e.m10)*2;t.w=(e.m08-e.m02)/r;t.x=(e.m01+e.m04)/r;t.y=.25*r;t.z=(e.m06+e.m09)/r}else{r=Math.sqrt(1+e.m10-e.m00-e.m05)*2;t.w=(e.m01-e.m04)/r;t.x=(e.m08+e.m02)/r;t.y=(e.m06+e.m09)/r;t.z=.25*r}return t};it.fromRTS=function(t,e,n,r){let a=e.x,s=e.y,i=e.z,m=e.w;let o=a+a;let l=s+s;let u=i+i;let h=a*o;let f=a*l;let c=a*u;let _=s*l;let d=s*u;let x=i*u;let g=m*o;let p=m*l;let y=m*u;let M=r.x;let w=r.y;let A=r.z;t.m00=(1-(_+x))*M;t.m01=(f+y)*M;t.m02=(c-p)*M;t.m03=0;t.m04=(f-y)*w;t.m05=(1-(h+x))*w;t.m06=(d+g)*w;t.m07=0;t.m08=(c+p)*A;t.m09=(d-g)*A;t.m10=(1-(h+_))*A;t.m11=0;t.m12=n.x;t.m13=n.y;t.m14=n.z;t.m15=1;return t};it.fromRTSOrigin=function(t,e,n,r,a){let s=e.x,i=e.y,m=e.z,o=e.w;let l=s+s;let u=i+i;let h=m+m;let f=s*l;let c=s*u;let _=s*h;let d=i*u;let x=i*h;let g=m*h;let p=o*l;let y=o*u;let M=o*h;let w=r.x;let A=r.y;let v=r.z;let S=a.x;let b=a.y;let E=a.z;t.m00=(1-(d+g))*w;t.m01=(c+M)*w;t.m02=(_-y)*w;t.m03=0;t.m04=(c-M)*A;t.m05=(1-(f+g))*A;t.m06=(x+p)*A;t.m07=0;t.m08=(_+y)*v;t.m09=(x-p)*v;t.m10=(1-(f+d))*v;t.m11=0;t.m12=n.x+S-(t.m00*S+t.m04*b+t.m08*E);t.m13=n.y+b-(t.m01*S+t.m05*b+t.m09*E);t.m14=n.z+E-(t.m02*S+t.m06*b+t.m10*E);t.m15=1;return t};it.fromQuat=function(t,e){let n=e.x,r=e.y,a=e.z,s=e.w;let i=n+n;let m=r+r;let o=a+a;let l=n*i;let u=r*i;let h=r*m;let f=a*i;let c=a*m;let _=a*o;let d=s*i;let x=s*m;let g=s*o;t.m00=1-h-_;t.m01=u+g;t.m02=f-x;t.m03=0;t.m04=u-g;t.m05=1-l-_;t.m06=c+d;t.m07=0;t.m08=f+x;t.m09=c-d;t.m10=1-l-h;t.m11=0;t.m12=0;t.m13=0;t.m14=0;t.m15=1;return t};it.frustum=function(t,e,n,r,a,s,i){let m=1/(n-e);let o=1/(a-r);let l=1/(s-i);t.m00=s*2*m;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=s*2*o;t.m06=0;t.m07=0;t.m08=(n+e)*m;t.m09=(a+r)*o;t.m10=(i+s)*l;t.m11=-1;t.m12=0;t.m13=0;t.m14=i*s*2*l;t.m15=0;return t};it.perspective=function(t,e,n,r,a){let s=1/Math.tan(e/2);let i=1/(r-a);t.m00=s/n;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=s;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=(a+r)*i;t.m11=-1;t.m12=0;t.m13=0;t.m14=2*a*r*i;t.m15=0;return t};it.perspectiveFromFieldOfView=function(t,e,n,r){let a=Math.tan(e.upDegrees*Math.PI/180);let s=Math.tan(e.downDegrees*Math.PI/180);let i=Math.tan(e.leftDegrees*Math.PI/180);let m=Math.tan(e.rightDegrees*Math.PI/180);let o=2/(i+m);let l=2/(a+s);t.m00=o;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=l;t.m06=0;t.m07=0;t.m08=-((i-m)*o*.5);t.m09=(a-s)*l*.5;t.m10=r/(n-r);t.m11=-1;t.m12=0;t.m13=0;t.m14=r*n/(n-r);t.m15=0;return t};it.ortho=function(t,e,n,r,a,s,i){let m=1/(e-n);let o=1/(r-a);let l=1/(s-i);t.m00=-2*m;t.m01=0;t.m02=0;t.m03=0;t.m04=0;t.m05=-2*o;t.m06=0;t.m07=0;t.m08=0;t.m09=0;t.m10=2*l;t.m11=0;t.m12=(e+n)*m;t.m13=(a+r)*o;t.m14=(i+s)*l;t.m15=1;return t};it.lookAt=function(t,e,r,a){let s,i,m,o,l,u,h,f,c,_;let d=e.x;let x=e.y;let g=e.z;let p=a.x;let y=a.y;let M=a.z;let w=r.x;let A=r.y;let v=r.z;if(Math.abs(d-w)<n&&Math.abs(x-A)<n&&Math.abs(g-v)<n){return it.identity(t)}h=d-w;f=x-A;c=g-v;_=1/Math.sqrt(h*h+f*f+c*c);h*=_;f*=_;c*=_;s=y*c-M*f;i=M*h-p*c;m=p*f-y*h;_=Math.sqrt(s*s+i*i+m*m);if(!_){s=0;i=0;m=0}else{_=1/_;s*=_;i*=_;m*=_}o=f*m-c*i;l=c*s-h*m;u=h*i-f*s;_=Math.sqrt(o*o+l*l+u*u);if(!_){o=0;l=0;u=0}else{_=1/_;o*=_;l*=_;u*=_}t.m00=s;t.m01=o;t.m02=h;t.m03=0;t.m04=i;t.m05=l;t.m06=f;t.m07=0;t.m08=m;t.m09=u;t.m10=c;t.m11=0;t.m12=-(s*d+i*x+m*g);t.m13=-(o*d+l*x+u*g);t.m14=-(h*d+f*x+c*g);t.m15=1;return t};it.str=function(t){return`mat4(${t.m00}, ${t.m01}, ${t.m02}, ${t.m03}, ${t.m04}, ${t.m05}, ${t.m06}, ${t.m07}, ${t.m08}, ${t.m09}, ${t.m10}, ${t.m11}, ${t.m12}, ${t.m13}, ${t.m14}, ${t.m15})`};it.array=function(t,e){t[0]=e.m00;t[1]=e.m01;t[2]=e.m02;t[3]=e.m03;t[4]=e.m04;t[5]=e.m05;t[6]=e.m06;t[7]=e.m07;t[8]=e.m08;t[9]=e.m09;t[10]=e.m10;t[11]=e.m11;t[12]=e.m12;t[13]=e.m13;t[14]=e.m14;t[15]=e.m15;return t};it.frob=function(t){return Math.sqrt(Math.pow(t.m00,2)+Math.pow(t.m01,2)+Math.pow(t.m02,2)+Math.pow(t.m03,2)+Math.pow(t.m04,2)+Math.pow(t.m05,2)+Math.pow(t.m06,2)+Math.pow(t.m07,2)+Math.pow(t.m08,2)+Math.pow(t.m09,2)+Math.pow(t.m10,2)+Math.pow(t.m11,2)+Math.pow(t.m12,2)+Math.pow(t.m13,2)+Math.pow(t.m14,2)+Math.pow(t.m15,2))};it.add=function(t,e,n){t.m00=e.m00+n.m00;t.m01=e.m01+n.m01;t.m02=e.m02+n.m02;t.m03=e.m03+n.m03;t.m04=e.m04+n.m04;t.m05=e.m05+n.m05;t.m06=e.m06+n.m06;t.m07=e.m07+n.m07;t.m08=e.m08+n.m08;t.m09=e.m09+n.m09;t.m10=e.m10+n.m10;t.m11=e.m11+n.m11;t.m12=e.m12+n.m12;t.m13=e.m13+n.m13;t.m14=e.m14+n.m14;t.m15=e.m15+n.m15;return t};it.subtract=function(t,e,n){t.m00=e.m00-n.m00;t.m01=e.m01-n.m01;t.m02=e.m02-n.m02;t.m03=e.m03-n.m03;t.m04=e.m04-n.m04;t.m05=e.m05-n.m05;t.m06=e.m06-n.m06;t.m07=e.m07-n.m07;t.m08=e.m08-n.m08;t.m09=e.m09-n.m09;t.m10=e.m10-n.m10;t.m11=e.m11-n.m11;t.m12=e.m12-n.m12;t.m13=e.m13-n.m13;t.m14=e.m14-n.m14;t.m15=e.m15-n.m15;return t};it.sub=it.subtract;it.multiplyScalar=function(t,e,n){t.m00=e.m00*n;t.m01=e.m01*n;t.m02=e.m02*n;t.m03=e.m03*n;t.m04=e.m04*n;t.m05=e.m05*n;t.m06=e.m06*n;t.m07=e.m07*n;t.m08=e.m08*n;t.m09=e.m09*n;t.m10=e.m10*n;t.m11=e.m11*n;t.m12=e.m12*n;t.m13=e.m13*n;t.m14=e.m14*n;t.m15=e.m15*n;return t};it.multiplyScalarAndAdd=function(t,e,n,r){t.m00=e.m00+n.m00*r;t.m01=e.m01+n.m01*r;t.m02=e.m02+n.m02*r;t.m03=e.m03+n.m03*r;t.m04=e.m04+n.m04*r;t.m05=e.m05+n.m05*r;t.m06=e.m06+n.m06*r;t.m07=e.m07+n.m07*r;t.m08=e.m08+n.m08*r;t.m09=e.m09+n.m09*r;t.m10=e.m10+n.m10*r;t.m11=e.m11+n.m11*r;t.m12=e.m12+n.m12*r;t.m13=e.m13+n.m13*r;t.m14=e.m14+n.m14*r;t.m15=e.m15+n.m15*r;return t};it.exactEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15};it.equals=function(t,e){let r=t.m00,a=t.m01,s=t.m02,i=t.m03,m=t.m04,o=t.m05,l=t.m06,u=t.m07,h=t.m08,f=t.m09,c=t.m10,_=t.m11,d=t.m12,x=t.m13,g=t.m14,p=t.m15;let y=e.m00,M=e.m01,w=e.m02,A=e.m03,v=e.m04,S=e.m05,b=e.m06,E=e.m07,z=e.m08,T=e.m09,P=e.m10,R=e.m11,L=e.m12,C=e.m13,D=e.m14,O=e.m15;return Math.abs(r-y)<=n*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(a-M)<=n*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(s-w)<=n*Math.max(1,Math.abs(s),Math.abs(w))&&Math.abs(i-A)<=n*Math.max(1,Math.abs(i),Math.abs(A))&&Math.abs(m-v)<=n*Math.max(1,Math.abs(m),Math.abs(v))&&Math.abs(o-S)<=n*Math.max(1,Math.abs(o),Math.abs(S))&&Math.abs(l-b)<=n*Math.max(1,Math.abs(l),Math.abs(b))&&Math.abs(u-E)<=n*Math.max(1,Math.abs(u),Math.abs(E))&&Math.abs(h-z)<=n*Math.max(1,Math.abs(h),Math.abs(z))&&Math.abs(f-T)<=n*Math.max(1,Math.abs(f),Math.abs(T))&&Math.abs(c-P)<=n*Math.max(1,Math.abs(c),Math.abs(P))&&Math.abs(_-R)<=n*Math.max(1,Math.abs(_),Math.abs(R))&&Math.abs(d-L)<=n*Math.max(1,Math.abs(d),Math.abs(L))&&Math.abs(x-C)<=n*Math.max(1,Math.abs(x),Math.abs(C))&&Math.abs(g-D)<=n*Math.max(1,Math.abs(g),Math.abs(D))&&Math.abs(p-O)<=n*Math.max(1,Math.abs(p),Math.abs(O))};let mt=new Array(3);class ot{constructor(t,e,n){this.r=t;this.g=e;this.b=n}toJSON(){mt[0]=this.r;mt[1]=this.g;mt[2]=this.b;return mt}}let lt={};lt.create=function(){return new ot(1,1,1)};lt.new=function(t,e,n){return new ot(t,e,n)};lt.clone=function(t){return new ot(t.r,t.g,t.b,t.a)};lt.copy=function(t,e){t.r=e.r;t.g=e.g;t.b=e.b;return t};lt.set=function(t,e,n,r){t.r=e;t.g=n;t.b=r;return t};lt.fromHex=function(t,e){let n=(e>>16)/255;let r=(e>>8&255)/255;let a=(e&255)/255;t.r=n;t.g=r;t.b=a;return t};lt.add=function(t,e,n){t.r=e.r+n.r;t.g=e.g+n.g;t.b=e.b+n.b;return t};lt.subtract=function(t,e,n){t.r=e.r-n.r;t.g=e.g-n.g;t.b=e.b-n.b;return t};lt.sub=lt.subtract;lt.multiply=function(t,e,n){t.r=e.r*n.r;t.g=e.g*n.g;t.b=e.b*n.b;return t};lt.mul=lt.multiply;lt.divide=function(t,e,n){t.r=e.r/n.r;t.g=e.g/n.g;t.b=e.b/n.b;return t};lt.div=lt.divide;lt.scale=function(t,e,n){t.r=e.r*n;t.g=e.g*n;t.b=e.b*n;return t};lt.lerp=function(t,e,n,r){let a=e.r,s=e.g,i=e.b;t.r=a+r*(n.r-a);t.g=s+r*(n.g-s);t.b=i+r*(n.b-i);return t};lt.str=function(t){return`color3(${t.r}, ${t.g}, ${t.b})`};lt.array=function(t,e){t[0]=e.r;t[1]=e.g;t[2]=e.b;return t};lt.exactEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b};lt.equals=function(t,e){let r=t.r,a=t.g,s=t.b;let i=e.r,m=e.g,o=e.b;return Math.abs(r-i)<=n*Math.max(1,Math.abs(r),Math.abs(i))&&Math.abs(a-m)<=n*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(s-o)<=n*Math.max(1,Math.abs(s),Math.abs(o))};lt.hex=function(t){return t.r*255<<16|t.g*255<<8|t.b*255};let ut=new Array(4);class ht{constructor(t,e,n,r){this.r=t;this.g=e;this.b=n;this.a=r}toJSON(){ut[0]=this.r;ut[1]=this.g;ut[2]=this.b;ut[3]=this.a;return ut}}let ft={};ft.create=function(){return new ht(1,1,1,1)};ft.new=function(t,e,n,r){return new ht(t,e,n,r)};ft.clone=function(t){return new ht(t.r,t.g,t.b,t.a)};ft.copy=function(t,e){t.r=e.r;t.g=e.g;t.b=e.b;t.a=e.a;return t};ft.set=function(t,e,n,r,a){t.r=e;t.g=n;t.b=r;t.a=a;return t};ft.fromHex=function(t,e){let n=(e>>24)/255;let r=(e>>16&255)/255;let a=(e>>8&255)/255;let s=(e&255)/255;t.r=n;t.g=r;t.b=a;t.a=s;return t};ft.add=function(t,e,n){t.r=e.r+n.r;t.g=e.g+n.g;t.b=e.b+n.b;t.a=e.a+n.a;return t};ft.subtract=function(t,e,n){t.r=e.r-n.r;t.g=e.g-n.g;t.b=e.b-n.b;t.a=e.a-n.a;return t};ft.sub=ft.subtract;ft.multiply=function(t,e,n){t.r=e.r*n.r;t.g=e.g*n.g;t.b=e.b*n.b;t.a=e.a*n.a;return t};ft.mul=ft.multiply;ft.divide=function(t,e,n){t.r=e.r/n.r;t.g=e.g/n.g;t.b=e.b/n.b;t.a=e.a/n.a;return t};ft.div=ft.divide;ft.scale=function(t,e,n){t.r=e.r*n;t.g=e.g*n;t.b=e.b*n;t.a=e.a*n;return t};ft.lerp=function(t,e,n,r){let a=e.r,s=e.g,i=e.b,m=e.a;t.r=a+r*(n.r-a);t.g=s+r*(n.g-s);t.b=i+r*(n.b-i);t.a=m+r*(n.a-m);return t};ft.str=function(t){return`color4(${t.r}, ${t.g}, ${t.b}, ${t.a})`};ft.array=function(t,e){t[0]=e.r;t[1]=e.g;t[2]=e.b;t[3]=e.a;return t};ft.exactEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a};ft.equals=function(t,e){let r=t.r,a=t.g,s=t.b,i=t.a;let m=e.r,o=e.g,l=e.b,u=e.a;return Math.abs(r-m)<=n*Math.max(1,Math.abs(r),Math.abs(m))&&Math.abs(a-o)<=n*Math.max(1,Math.abs(a),Math.abs(o))&&Math.abs(s-l)<=n*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(i-u)<=n*Math.max(1,Math.abs(i),Math.abs(u))};ft.hex=function(t){return(t.r*255<<24|t.g*255<<16|t.b*255<<8|t.a*255)>>>0};let ct=N;var _t=Object.freeze({bits:ct,vec2:U,vec3:k,vec4:$,quat:J,mat2:tt,mat23:rt,mat3:Y,mat4:it,color3:lt,color4:ft,EPSILON:n,equals:r,approx:a,clamp:s,clamp01:i,lerp:m,toRadian:o,toDegree:l,random:u,randomRange:h,randomRangeInt:f,nextPow2:c});var dt={PROJ_PERSPECTIVE:0,PROJ_ORTHO:1,LIGHT_DIRECTIONAL:0,LIGHT_POINT:1,LIGHT_SPOT:2,SHADOW_NONE:0,SHADOW_HARD:1,SHADOW_SOFT:2,PARAM_INT:0,PARAM_INT2:1,PARAM_INT3:2,PARAM_INT4:3,PARAM_FLOAT:4,PARAM_FLOAT2:5,PARAM_FLOAT3:6,PARAM_FLOAT4:7,PARAM_COLOR3:8,PARAM_COLOR4:9,PARAM_MAT2:10,PARAM_MAT3:11,PARAM_MAT4:12,PARAM_TEXTURE_2D:13,PARAM_TEXTURE_CUBE:14,CLEAR_COLOR:1,CLEAR_DEPTH:2,CLEAR_STENCIL:4};class xt{constructor(t,e,n=gfx.PT_TRIANGLES){this._vertexBuffer=t;this._indexBuffer=e;this._primitiveType=n;this._start=0;this._count=-1}getPrimitiveCount(){if(this._count!==-1){return this._count}if(this._indexBuffer){return this._indexBuffer.count}return this._vertexBuffer.count}}class gt{constructor(t){this._programName=t;this._cullMode=gfx.CULL_BACK;this._blend=false;this._blendEq=gfx.BLEND_FUNC_ADD;this._blendAlphaEq=gfx.BLEND_FUNC_ADD;this._blendSrc=gfx.BLEND_ONE;this._blendDst=gfx.BLEND_ZERO;this._blendSrcAlpha=gfx.BLEND_ONE;this._blendDstAlpha=gfx.BLEND_ZERO;this._blendColor=4294967295;this._depthTest=false;this._depthWrite=false;this._depthFunc=gfx.DS_FUNC_LESS,this._stencilTest=false;this._stencilFuncFront=gfx.DS_FUNC_ALWAYS;this._stencilRefFront=0;this._stencilMaskFront=255;this._stencilFailOpFront=gfx.STENCIL_OP_KEEP;this._stencilZFailOpFront=gfx.STENCIL_OP_KEEP;this._stencilZPassOpFront=gfx.STENCIL_OP_KEEP;this._stencilWriteMaskFront=255;this._stencilFuncBack=gfx.DS_FUNC_ALWAYS;this._stencilRefBack=0;this._stencilMaskBack=255;this._stencilFailOpBack=gfx.STENCIL_OP_KEEP;this._stencilZFailOpBack=gfx.STENCIL_OP_KEEP;this._stencilZPassOpBack=gfx.STENCIL_OP_KEEP;this._stencilWriteMaskBack=255}setCullMode(t){this._cullMode=t}setBlend(t=gfx.BLEND_FUNC_ADD,e=gfx.BLEND_ONE,n=gfx.BLEND_ZERO,r=gfx.BLEND_FUNC_ADD,a=gfx.BLEND_ONE,s=gfx.BLEND_ZERO,i=4294967295){this._blend=true;this._blendEq=t;this._blendSrc=e;this._blendDst=n;this._blendAlphaEq=r;this._blendSrcAlpha=a;this._blendDstAlpha=s;this._blendColor=i}setDepth(t=false,e=false,n=gfx.DS_FUNC_LESS){this._depthTest=t;this._depthWrite=e;this._depthFunc=n}setStencilFront(t=gfx.DS_FUNC_ALWAYS,e=0,n=255,r=gfx.STENCIL_OP_KEEP,a=gfx.STENCIL_OP_KEEP,s=gfx.STENCIL_OP_KEEP,i=255){this._stencilTest=true;this._stencilFuncFront=t;this._stencilRefFront=e;this._stencilMaskFront=n;this._stencilFailOpFront=r;this._stencilZFailOpFront=a;this._stencilZPassOpFront=s;this._stencilWriteMaskFront=i}setStencilBack(t=gfx.DS_FUNC_ALWAYS,e=0,n=255,r=gfx.STENCIL_OP_KEEP,a=gfx.STENCIL_OP_KEEP,s=gfx.STENCIL_OP_KEEP,i=255){this._stencilTest=true;this._stencilFuncBack=t;this._stencilRefBack=e;this._stencilMaskBack=n;this._stencilFailOpBack=r;this._stencilZFailOpBack=a;this._stencilZPassOpBack=s;this._stencilWriteMaskBack=i}}let pt=0;let yt={};var Mt={addStage:function(t){if(yt[t]!==undefined){return}let e=1<<pt;yt[t]=e;pt+=1},stageID:function(t){let e=yt[t];if(e===undefined){return-1}return e},stageIDs:function(t){let e=0;for(let n=0;n<t.length;++n){let r=yt[t[n]];if(r!==undefined){e|=r}}return e}};let wt=0;class At{constructor(t,e,n,r=0){this._id=wt++;this._stageIDs=Mt.stageIDs(t);this._parameters=e;this._passes=n;this._layer=r}setStages(t){this._stageIDs=Mt.stageIDs(t)}get passes(){return this._passes}get stageIDs(){return this._stageIDs}}class vt{constructor(t,e={},n=[]){this._techniques=t;this._properties=e;this._defines=n}clear(){this._techniques.length=0;this._properties=null;this._defines.length=0}getTechnique(t){let e=Mt.stageID(t);for(let t=0;t<this._techniques.length;++t){let n=this._techniques[t];if(n.stageIDs&e){return n}}return null}getProperty(t){return this._properties[t]}setProperty(t,e){this._properties[t]=e}getDefine(t){for(let e=0;e<this._defines.length;++e){let n=this._defines[e];if(n.name===t){return n.value}}console.warn(`Failed to get define ${t}, define not found.`);return null}define(t,e){for(let n=0;n<this._defines.length;++n){let r=this._defines[n];if(r.name===t){r.value=e;return}}console.warn(`Failed to set define ${t}, define not found.`)}extractDefines(t={}){for(let e=0;e<this._defines.length;++e){let n=this._defines[e];t[n.name]=n.value}return t}}const St={none:gfx.CULL_NONE,front:gfx.CULL_FRONT,back:gfx.CULL_BACK,front_and_back:gfx.CULL_FRONT_AND_BACK};const bt={add:gfx.BLEND_FUNC_ADD,sub:gfx.BLEND_FUNC_SUBTRACT,reverse_sub:gfx.BLEND_FUNC_REVERSE_SUBTRACT};const Et={zero:gfx.BLEND_ZERO,one:gfx.BLEND_ONE,src_color:gfx.BLEND_SRC_COLOR,one_minus_src_color:gfx.BLEND_ONE_MINUS_SRC_COLOR,dst_color:gfx.BLEND_DST_COLOR,one_minus_dst_color:gfx.BLEND_ONE_MINUS_DST_COLOR,src_alpha:gfx.BLEND_SRC_ALPHA,one_minus_src_alpha:gfx.BLEND_ONE_MINUS_SRC_ALPHA,dst_alpha:gfx.BLEND_DST_ALPHA,one_minus_dst_alpha:gfx.BLEND_ONE_MINUS_DST_ALPHA,constant_color:gfx.BLEND_CONSTANT_COLOR,one_minus_constant_color:gfx.BLEND_ONE_MINUS_CONSTANT_COLOR,constant_alpha:gfx.BLEND_CONSTANT_ALPHA,one_minus_constant_alpha:gfx.BLEND_ONE_MINUS_CONSTANT_ALPHA,src_alpha_saturate:gfx.BLEND_SRC_ALPHA_SATURATE};const zt={never:gfx.DS_FUNC_NEVER,less:gfx.DS_FUNC_LESS,equal:gfx.DS_FUNC_EQUAL,lequal:gfx.DS_FUNC_LEQUAL,greater:gfx.DS_FUNC_GREATER,notequal:gfx.DS_FUNC_NOTEQUAL,gequal:gfx.DS_FUNC_GEQUAL,always:gfx.DS_FUNC_ALWAYS};const Tt={keep:gfx.STENCIL_OP_KEEP,zero:gfx.STENCIL_OP_ZERO,replace:gfx.STENCIL_OP_REPLACE,incr:gfx.STENCIL_OP_INCR,incr_wrap:gfx.STENCIL_OP_INCR_WRAP,decr:gfx.STENCIL_OP_DECR,decr_wrap:gfx.STENCIL_OP_DECR_WRAP,inver:gfx.STENCIL_OP_INVERT};function Pt(t,e){if(!e.positions){console.error("The data must have positions field");return null}let n=[];let r=e.positions.length/3;for(let t=0;t<r;++t){n.push(e.positions[3*t],e.positions[3*t+1],e.positions[3*t+2]);if(e.normals){n.push(e.normals[3*t],e.normals[3*t+1],e.normals[3*t+2])}if(e.uvs){n.push(e.uvs[2*t],e.uvs[2*t+1])}}let a=[];a.push({name:gfx.ATTR_POSITION,type:gfx.ATTR_TYPE_FLOAT32,num:3});if(e.normals){a.push({name:gfx.ATTR_NORMAL,type:gfx.ATTR_TYPE_FLOAT32,num:3})}if(e.uvs){a.push({name:gfx.ATTR_UV0,type:gfx.ATTR_TYPE_FLOAT32,num:2})}let s=new gfx.VertexBuffer(t,new gfx.VertexFormat(a),gfx.USAGE_STATIC,new Float32Array(n),r);let i=null;if(e.indices){i=new gfx.IndexBuffer(t,gfx.INDEX_FMT_UINT16,gfx.USAGE_STATIC,new Uint16Array(e.indices),e.indices.length)}return new xt(s,i)}let Rt=it.create();let Lt=0;class Ct{constructor(){this._id=Lt++;this._rect={x:0,y:0,w:1,h:1};this._color=ft.new(.3,.3,.3,1);this._depth=1;this._stencil=1;this._clearFlags=dt.CLEAR_COLOR|dt.CLEAR_DEPTH;this._matView=it.create();this._matProj=it.create();this._matViewProj=it.create();this._matInvViewProj=it.create();this._stages=[];this._cullingByID=false;this._framebuffer=null;this._shadowLight=null}getForward(t){return k.set(t,-this._matView.m02,-this._matView.m06,-this._matView.m10)}getPosition(t){it.invert(Rt,this._matView);return it.getTranslation(t,Rt)}}const Dt=k.new(0,0,-1);let Ot=it.create();let It=Y.create();let Nt=k.create();function Ft(t,e,n){t._node.getWorldRT(e);it.invert(e,e);it.perspective(n,t._spotAngle*t._spotAngleScale,1,t._shadowMinDepth,t._shadowMaxDepth)}function Bt(t,e,n){t._node.getWorldRT(e);it.invert(e,e);let r=t._shadowFustumSize/2;it.ortho(n,-r,r,-r,r,t._shadowMinDepth,t._shadowMaxDepth)}function Ut(t,e,n){}class Vt{constructor(){this._poolID=-1;this._node=null;this._type=dt.LIGHT_DIRECTIONAL;this._color=lt.new(1,1,1);this._intensity=1;this._range=1;this._spotAngle=o(60);this._spotExp=1;this._directionUniform=new Float32Array(3);this._positionUniform=new Float32Array(3);this._colorUniform=new Float32Array([this._color.r*this._intensity,this._color.g*this._intensity,this._color.b*this._intensity]);this._spotUniform=new Float32Array([Math.cos(this._spotAngle*.5),this._spotExp]);this._shadowType=dt.SHADOW_NONE;this._shadowFrameBuffer=null;this._shadowMap=null;this._shadowMapDirty=false;this._shadowDepthBuffer=null;this._shadowResolution=1024;this._shadowBias=5e-5;this._shadowDarkness=1;this._shadowMinDepth=1;this._shadowMaxDepth=1e3;this._shadowDepthScale=50;this._frustumEdgeFalloff=0;this._viewProjMatrix=it.create();this._spotAngleScale=1;this._shadowFustumSize=80}setNode(t){this._node=t}setColor(t,e,n){lt.set(this._color,t,e,n);this._colorUniform[0]=t*this._intensity;this._colorUniform[1]=e*this._intensity;this._colorUniform[2]=n*this._intensity}get color(){return this._color}setIntensity(t){this._intensity=t;this._colorUniform[0]=t*this._color.r;this._colorUniform[1]=t*this._color.g;this._colorUniform[2]=t*this._color.b}get intensity(){return this._intensity}setType(t){this._type=t}get type(){return this._type}setSpotAngle(t){this._spotAngle=t;this._spotUniform[0]=Math.cos(this._spotAngle*.5)}get spotAngle(){return this._spotAngle}setSpotExp(t){this._spotExp=t;this._spotUniform[1]=t}get spotExp(){return this._spotExp}setRange(t){this._range=t}get range(){return this._range}setShadowType(t){if(this._shadowType===dt.SHADOW_NONE&&t!==dt.SHADOW_NONE){this._shadowMapDirty=true}this._shadowType=t}get shadowType(){return this._shadowType}get shadowMap(){return this._shadowMap}get viewProjMatrix(){return this._viewProjMatrix}setShadowResolution(t){if(this._shadowResolution!==t){this._shadowMapDirty=true}this._shadowResolution=t}get shadowResolution(){return this._shadowResolution}setShadowBias(t){this._shadowBias=t}get shadowBias(){return this._shadowBias}setShadowDarkness(t){this._shadowDarkness=t}get shadowDarkness(){return this._shadowDarkness}setShadowMinDepth(t){this._shadowMinDepth=t}get shadowMinDepth(){if(this._type===dt.LIGHT_DIRECTIONAL){return 1}return this._shadowMinDepth}setShadowMaxDepth(t){this._shadowMaxDepth=t}get shadowMaxDepth(){if(this._type===dt.LIGHT_DIRECTIONAL){return 1}return this._shadowMaxDepth}setShadowDepthScale(t){this._shadowDepthScale=t}get shadowDepthScale(){return this._shadowDepthScale}setFrustumEdgeFalloff(t){this._frustumEdgeFalloff=t}get frustumEdgeFalloff(){return this._frustumEdgeFalloff}extractView(t,e){t._shadowLight=this;t._rect.x=0;t._rect.y=0;t._rect.w=this._shadowResolution;t._rect.h=this._shadowResolution;ft.set(t._color,1,1,1,1);t._depth=1;t._stencil=1;t._clearFlags=dt.CLEAR_COLOR|dt.CLEAR_DEPTH;t._stages=e;t._framebuffer=this._shadowFrameBuffer;switch(this._type){case dt.LIGHT_SPOT:Ft(this,t._matView,t._matProj);break;case dt.LIGHT_DIRECTIONAL:Bt(this,t._matView,t._matProj);break;case dt.LIGHT_POINT:Ut(this,t._matView,t._matProj);break;default:console.warn("shadow of this light type is not supported")}it.mul(t._matViewProj,t._matProj,t._matView);this._viewProjMatrix=t._matViewProj;it.invert(t._matInvViewProj,t._matViewProj)}_updateLightPositionAndDirection(){this._node.getWorldMatrix(Ot);Y.fromMat4(It,Ot);k.transformMat3(Nt,Dt,It);k.array(this._directionUniform,Nt);let t=this._positionUniform;t[0]=Ot.m12;t[1]=Ot.m13;t[2]=Ot.m14}_generateShadowMap(t){this._shadowMap=new gfx.Texture2D(t,{width:this._shadowResolution,height:this._shadowResolution,format:gfx.TEXTURE_FMT_RGBA8,wrapS:gfx.WRAP_CLAMP,wrapT:gfx.WRAP_CLAMP});this._shadowDepthBuffer=new gfx.RenderBuffer(t,gfx.RB_FMT_D16,this._shadowResolution,this._shadowResolution);this._shadowFrameBuffer=new gfx.FrameBuffer(t,this._shadowResolution,this._shadowResolution,{colors:[this._shadowMap],depth:this._shadowDepthBuffer})}_destroyShadowMap(){if(this._shadowMap){this._shadowMap.destroy();this._shadowDepthBuffer.destroy();this._shadowFrameBuffer.destroy();this._shadowMap=null;this._shadowDepthBuffer=null;this._shadowFrameBuffer=null}}update(t){this._updateLightPositionAndDirection();if(this._shadowType===dt.SHADOW_NONE){this._destroyShadowMap()}else if(this._shadowMapDirty){this._destroyShadowMap();this._generateShadowMap(t);this._shadowMapDirty=false}}}let qt=it.create();let kt=it.create();let jt=it.create();let Ht=it.create();let $t=k.create();class Gt{constructor(){this._poolID=-1;this._node=null;this._projection=dt.PROJ_PERSPECTIVE;this._color=ft.new(.2,.3,.47,1);this._depth=1;this._stencil=1;this._clearFlags=dt.CLEAR_COLOR|dt.CLEAR_DEPTH;this._stages=[];this._framebuffer=null;this._near=.01;this._far=1e3;this._fov=Math.PI/4;this._rect={x:0,y:0,w:1,h:1};this._orthoHeight=10}getNode(){return this._node}setNode(t){this._node=t}getType(){return this._projection}setType(t){this._projection=t}getOrthoHeight(){return this._orthoHeight}setOrthoHeight(t){this._orthoHeight=t}getFov(){return this._fov}setFov(t){this._fov=t}getNear(){return this._near}setNear(t){this._near=t}getFar(){return this._far}setFar(t){this._far=t}getColor(t){return ft.copy(t,this._color)}setColor(t,e,n,r){ft.set(this._color,t,e,n,r)}getDepth(){return this._depth}setDepth(t){this._depth=t}getStencil(){return this._stencil}setStencil(t){this._stencil=t}getClearFlags(){return this._clearFlags}setClearFlags(t){this._clearFlags=t}getRect(t){t.x=this._rect.x;t.y=this._rect.y;t.w=this._rect.w;t.h=this._rect.h;return t}setRect(t,e,n,r){this._rect.x=t;this._rect.y=e;this._rect.w=n;this._rect.h=r}getStages(){return this._stages}setStages(t){this._stages=t}getFramebuffer(){return this._framebuffer}setFramebuffer(t){this._framebuffer=t}extractView(t,e,n){t._rect.x=this._rect.x*e;t._rect.y=this._rect.y*n;t._rect.w=this._rect.w*e;t._rect.h=this._rect.h*n;t._color=this._color;t._depth=this._depth;t._stencil=this._stencil;t._clearFlags=this._clearFlags;t._stages=this._stages;t._framebuffer=this._framebuffer;this._node.getWorldRT(t._matView);it.invert(t._matView,t._matView);let r=e/n;if(this._projection===dt.PROJ_PERSPECTIVE){it.perspective(t._matProj,this._fov,r,this._near,this._far)}else{let e=this._orthoHeight*r;let n=this._orthoHeight;it.ortho(t._matProj,-e,e,-n,n,this._near,this._far)}it.mul(t._matViewProj,t._matProj,t._matView);it.invert(t._matInvViewProj,t._matViewProj)}screenToWorld(t,e,n,r){let a=n/r;let s=this._rect.x*n;let i=this._rect.y*r;let m=this._rect.w*n;let o=this._rect.h*r;this._node.getWorldRT(qt);it.invert(qt,qt);if(this._projection===dt.PROJ_PERSPECTIVE){it.perspective(kt,this._fov,a,this._near,this._far)}else{let t=this._orthoHeight*a;let e=this._orthoHeight;it.ortho(kt,-t,t,-e,e,this._near,this._far)}it.mul(jt,kt,qt);it.invert(Ht,jt);if(this._projection===dt.PROJ_PERSPECTIVE){k.set(t,(e.x-s)*2/m-1,(e.y-i)*2/o-1,1);k.transformMat4(t,t,Ht);this._node.getWorldPos($t);k.lerp(t,$t,t,e.z/this._far)}else{let n=this._farClip-this._nearClip;k.set(t,(e.x-s)*2/m-1,(e.y-i)*2/o-1,(this._far-e.z)/n*2-1);k.transformMat4(t,t,Ht)}return t}worldToScreen(t,e,n,r){let a=n/r;let s=this._rect.x*n;let i=this._rect.y*r;let m=this._rect.w*n;let o=this._rect.h*r;this._node.getWorldRT(qt);it.invert(qt,qt);if(this._projection===dt.PROJ_PERSPECTIVE){it.perspective(kt,this._fov,a,this._near,this._far)}else{let t=this._orthoHeight*a;let e=this._orthoHeight;it.ortho(kt,-t,t,-e,e,this._near,this._far)}it.mul(jt,kt,qt);let l=e.x*jt.m03+e.y*jt.m07+e.z*jt.m11+jt.m15;k.transformMat4(t,e,jt);t.x=s+(t.x/l+1)*.5*m;t.y=i+(t.y/l+1)*.5*o;return t}}class Wt{constructor(){this._poolID=-1;this._node=null;this._inputAssemblers=[];this._effects=[];this._defines=[];this._dynamicIA=false;this._viewID=-1}get inputAssemblerCount(){return this._inputAssemblers.length}get dynamicIA(){return this._dynamicIA}get drawItemCount(){return this._dynamicIA?1:this._inputAssemblers.length}setNode(t){this._node=t}setDynamicIA(t){this._dynamicIA=t}addInputAssembler(t){if(this._inputAssemblers.indexOf(t)!==-1){return}this._inputAssemblers.push(t)}clearInputAssemblers(){this._inputAssemblers.length=0}addEffect(t){if(this._effects.indexOf(t)!==-1){return}this._effects.push(t);let e=Object.create(null);t.extractDefines(e);this._defines.push(e)}clearEffects(){this._effects.length=0;this._defines.length=0}extractDrawItem(t,e){if(this._dynamicIA){t.model=this;t.node=this._node;t.ia=null;t.effect=this._effects[0];t.defines=t.effect.extractDefines(this._defines[0]);return}if(e>=this._inputAssemblers.length){t.model=null;t.node=null;t.ia=null;t.effect=null;t.defines=null;return}t.model=this;t.node=this._node;t.ia=this._inputAssemblers[e];let n,r;if(e<this._effects.length){n=this._effects[e];r=this._defines[e]}else{n=this._effects[this._effects.length-1];r=this._defines[this._effects.length-1]}t.effect=n;t.defines=n.extractDefines(r)}}const Yt=32;const Xt=7;const Zt=256;const Jt=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9];function Kt(t){if(t<1e5){if(t<100){return t<10?0:1}if(t<1e4){return t<1e3?2:3}return 4}if(t<1e7){return t<1e6?5:6}if(t<1e9){return t<1e8?7:8}return 9}function Qt(t,e){if(t===e){return 0}if(~~t===t&&~~e===e){if(t===0||e===0){return t<e?-1:1}if(t<0||e<0){if(e>=0){return-1}if(t>=0){return 1}t=-t;e=-e}const n=Kt(t);const r=Kt(e);let a=0;if(n<r){t*=Jt[r-n-1];e/=10;a=-1}else if(n>r){e*=Jt[n-r-1];t/=10;a=1}if(t===e){return a}return t<e?-1:1}let n=String(t);let r=String(e);if(n===r){return 0}return n<r?-1:1}function te(t){let e=0;while(t>=Yt){e|=t&1;t>>=1}return t+e}function ee(t,e,n,r){let a=e+1;if(a===n){return 1}if(r(t[a++],t[e])<0){while(a<n&&r(t[a],t[a-1])<0){a++}ne(t,e,a)}else{while(a<n&&r(t[a],t[a-1])>=0){a++}}return a-e}function ne(t,e,n){n--;while(e<n){let r=t[e];t[e++]=t[n];t[n--]=r}}function re(t,e,n,r,a){if(r===e){r++}for(;r<n;r++){let n=t[r];let s=e;let i=r;while(s<i){let e=s+i>>>1;if(a(n,t[e])<0){i=e}else{s=e+1}}let m=r-s;switch(m){case 3:t[s+3]=t[s+2];case 2:t[s+2]=t[s+1];case 1:t[s+1]=t[s];break;default:while(m>0){t[s+m]=t[s+m-1];m--}}t[s]=n}}function ae(t,e,n,r,a,s){let i=0;let m=0;let o=1;if(s(t,e[n+a])>0){m=r-a;while(o<m&&s(t,e[n+a+o])>0){i=o;o=(o<<1)+1;if(o<=0){o=m}}if(o>m){o=m}i+=a;o+=a}else{m=a+1;while(o<m&&s(t,e[n+a-o])<=0){i=o;o=(o<<1)+1;if(o<=0){o=m}}if(o>m){o=m}let r=i;i=a-o;o=a-r}i++;while(i<o){let r=i+(o-i>>>1);if(s(t,e[n+r])>0){i=r+1}else{o=r}}return o}function se(t,e,n,r,a,s){let i=0;let m=0;let o=1;if(s(t,e[n+a])<0){m=a+1;while(o<m&&s(t,e[n+a-o])<0){i=o;o=(o<<1)+1;if(o<=0){o=m}}if(o>m){o=m}let r=i;i=a-o;o=a-r}else{m=r-a;while(o<m&&s(t,e[n+a+o])>=0){i=o;o=(o<<1)+1;if(o<=0){o=m}}if(o>m){o=m}i+=a;o+=a}i++;while(i<o){let r=i+(o-i>>>1);if(s(t,e[n+r])<0){o=r}else{i=r+1}}return o}class ie{constructor(t,e){this.array=t;this.compare=e;this.minGallop=Xt;this.length=t.length;this.tmpStorageLength=Zt;if(this.length<2*Zt){this.tmpStorageLength=this.length>>>1}this.tmp=new Array(this.tmpStorageLength);this.stackLength=this.length<120?5:this.length<1542?10:this.length<119151?19:40;this.runStart=new Array(this.stackLength);this.runLength=new Array(this.stackLength);this.stackSize=0}pushRun(t,e){this.runStart[this.stackSize]=t;this.runLength[this.stackSize]=e;this.stackSize+=1}mergeRuns(){while(this.stackSize>1){let t=this.stackSize-2;if(t>=1&&this.runLength[t-1]<=this.runLength[t]+this.runLength[t+1]||t>=2&&this.runLength[t-2]<=this.runLength[t]+this.runLength[t-1]){if(this.runLength[t-1]<this.runLength[t+1]){t--}}else if(this.runLength[t]>this.runLength[t+1]){break}this.mergeAt(t)}}forceMergeRuns(){while(this.stackSize>1){let t=this.stackSize-2;if(t>0&&this.runLength[t-1]<this.runLength[t+1]){t--}this.mergeAt(t)}}mergeAt(t){let e=this.compare;let n=this.array;let r=this.runStart[t];let a=this.runLength[t];let s=this.runStart[t+1];let i=this.runLength[t+1];this.runLength[t]=a+i;if(t===this.stackSize-3){this.runStart[t+1]=this.runStart[t+2];this.runLength[t+1]=this.runLength[t+2]}this.stackSize--;let m=se(n[s],n,r,a,0,e);r+=m;a-=m;if(a===0){return}i=ae(n[r+a-1],n,s,i,i-1,e);if(i===0){return}if(a<=i){this.mergeLow(r,a,s,i)}else{this.mergeHigh(r,a,s,i)}}mergeLow(t,e,n,r){let a=this.compare;let s=this.array;let i=this.tmp;let m=0;for(m=0;m<e;m++){i[m]=s[t+m]}let o=0;let l=n;let u=t;s[u++]=s[l++];if(--r===0){for(m=0;m<e;m++){s[u+m]=i[o+m]}return}if(e===1){for(m=0;m<r;m++){s[u+m]=s[l+m]}s[u+r]=i[o];return}let h=this.minGallop;while(true){let t=0;let n=0;let f=false;do{if(a(s[l],i[o])<0){s[u++]=s[l++];n++;t=0;if(--r===0){f=true;break}}else{s[u++]=i[o++];t++;n=0;if(--e===1){f=true;break}}}while((t|n)<h);if(f){break}do{t=se(s[l],i,o,e,0,a);if(t!==0){for(m=0;m<t;m++){s[u+m]=i[o+m]}u+=t;o+=t;e-=t;if(e<=1){f=true;break}}s[u++]=s[l++];if(--r===0){f=true;break}n=ae(i[o],s,l,r,0,a);if(n!==0){for(m=0;m<n;m++){s[u+m]=s[l+m]}u+=n;l+=n;r-=n;if(r===0){f=true;break}}s[u++]=i[o++];if(--e===1){f=true;break}h--}while(t>=Xt||n>=Xt);if(f){break}if(h<0){h=0}h+=2}this.minGallop=h;if(h<1){this.minGallop=1}if(e===1){for(m=0;m<r;m++){s[u+m]=s[l+m]}s[u+r]=i[o]}else if(e===0){throw new Error("mergeLow preconditions were not respected")}else{for(m=0;m<e;m++){s[u+m]=i[o+m]}}}mergeHigh(t,e,n,r){let a=this.compare;let s=this.array;let i=this.tmp;let m=0;for(m=0;m<r;m++){i[m]=s[n+m]}let o=t+e-1;let l=r-1;let u=n+r-1;let h=0;let f=0;s[u--]=s[o--];if(--e===0){h=u-(r-1);for(m=0;m<r;m++){s[h+m]=i[m]}return}if(r===1){u-=e;o-=e;f=u+1;h=o+1;for(m=e-1;m>=0;m--){s[f+m]=s[h+m]}s[u]=i[l];return}let c=this.minGallop;while(true){let n=0;let _=0;let d=false;do{if(a(i[l],s[o])<0){s[u--]=s[o--];n++;_=0;if(--e===0){d=true;break}}else{s[u--]=i[l--];_++;n=0;if(--r===1){d=true;break}}}while((n|_)<c);if(d){break}do{n=e-se(i[l],s,t,e,e-1,a);if(n!==0){u-=n;o-=n;e-=n;f=u+1;h=o+1;for(m=n-1;m>=0;m--){s[f+m]=s[h+m]}if(e===0){d=true;break}}s[u--]=i[l--];if(--r===1){d=true;break}_=r-ae(s[o],i,0,r,r-1,a);if(_!==0){u-=_;l-=_;r-=_;f=u+1;h=l+1;for(m=0;m<_;m++){s[f+m]=i[h+m]}if(r<=1){d=true;break}}s[u--]=s[o--];if(--e===0){d=true;break}c--}while(n>=Xt||_>=Xt);if(d){break}if(c<0){c=0}c+=2}this.minGallop=c;if(c<1){this.minGallop=1}if(r===1){u-=e;o-=e;f=u+1;h=o+1;for(m=e-1;m>=0;m--){s[f+m]=s[h+m]}s[u]=i[l]}else if(r===0){throw new Error("mergeHigh preconditions were not respected")}else{h=u-(r-1);for(m=0;m<r;m++){s[h+m]=i[m]}}}}function me(t,e,n,r){if(!Array.isArray(t)){throw new TypeError("Can only sort arrays")}if(e===undefined){e=0}if(n===undefined){n=t.length}if(r===undefined){r=Qt}let a=n-e;if(a<2){return}let s=0;if(a<Yt){s=ee(t,e,n,r);re(t,e,n,e+s,r);return}let i=new ie(t,r);let m=te(a);do{s=ee(t,e,n,r);if(s<m){let n=a;if(n>m){n=m}re(t,e,e+n,e+s,r);s=n}i.pushRun(e,s);i.mergeRuns();a-=s;e+=s}while(a!==0);i.forceMergeRuns()}class oe{constructor(t){this._count=0;this._data=new Array(t)}_resize(t){if(t>this._data.length){for(let e=this._data.length;e<t;++e){this._data[e]=undefined}}}get length(){return this._count}get data(){return this._data}reset(){for(let t=0;t<this._count;++t){this._data[t]=undefined}this._count=0}push(t){if(this._count>=this._data.length){this._resize(this._data.length*2)}this._data[this._count]=t;++this._count}pop(){--this._count;if(this._count<0){this._count=0}let t=this._data[this._count];this._data[this._count]=undefined;return t}fastRemove(t){if(t>=this._count){return}let e=this._count-1;this._data[t]=this._data[e];this._data[e]=undefined;this._count-=1}indexOf(t){let e=this._data.indexOf(t);if(e>=this._count){return-1}return e}sort(t){return me(this._data,0,this._count,t)}}class le{constructor(t,e){this._fn=t;this._idx=e-1;this._frees=new Array(e);for(let n=0;n<e;++n){this._frees[n]=t()}}_expand(t){let e=this._frees;this._frees=new Array(t);let n=t-e.length;for(let t=0;t<n;++t){this._frees[t]=this._fn()}for(let r=n,a=0;r<t;++r,++a){this._frees[r]=e[a]}this._idx+=n}alloc(){if(this._idx<0){this._expand(Math.round(this._frees.length*1.2)+1)}let t=this._frees[this._idx];this._frees[this._idx]=null;--this._idx;return t}free(t){++this._idx;this._frees[this._idx]=t}}class ue{constructor(t,e){this._fn=t;this._count=0;this._data=new Array(e);for(let n=0;n<e;++n){this._data[n]=t()}}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(t){if(t>this._data.length){for(let e=this._data.length;e<t;++e){this._data[e]=this._fn()}}}add(){if(this._count>=this._data.length){this.resize(this._data.length*2)}return this._data[this._count++]}remove(t){if(t>=this._count){return}let e=this._count-1;let n=this._data[t];this._data[t]=this._data[e];this._data[e]=n;this._count-=1}sort(t){return me(this._data,0,this._count,t)}}let he=Array(8);for(let t=0;t<8;++t){he[t]=[]}class fe{constructor(){this._lights=new oe(16);this._models=new oe(16);this._cameras=new oe(16);this._debugCamera=null;this._views=[]}_add(t,e){if(e._poolID!==-1){return}t.push(e);e._poolID=t.length-1}_remove(t,e){if(e._poolID===-1){return}t.data[t.length-1]._poolID=e._poolID;t.fastRemove(e._poolID);e._poolID=-1}reset(){for(let t=0;t<this._models.length;++t){let e=this._models.data[t];e._viewID=-1}}setDebugCamera(t){this._debugCamera=t}getCameraCount(){return this._cameras.length}getCamera(t){return this._cameras.data[t]}addCamera(t){this._add(this._cameras,t)}removeCamera(t){this._remove(this._cameras,t)}getModelCount(){return this._models.length}getModel(t){return this._models.data[t]}addModel(t){this._add(this._models,t)}removeModel(t){this._remove(this._models,t)}getLightCount(){return this._lights.length}getLight(t){return this._lights.data[t]}addLight(t){this._add(this._lights,t)}removeLight(t){this._remove(this._lights,t)}addView(t){if(this._views.indexOf(t)===-1){this._views.push(t)}}removeView(t){let e=this._views.indexOf(t);if(e!==-1){this._views.splice(e,1)}}}let ce=0;function _e(t){let e=[];for(let n in t){if(t[n]===true){e.push(`#define ${n}`)}}return e.join("\n")}function de(t,e){let n={};let r=t;for(let t in e){if(Number.isInteger(e[t])){n[t]=e[t]}}for(let t in n){let e=new RegExp(t,"g");r=r.replace(e,n[t])}return r}function xe(t){let e=/#pragma for (\w+) in range\(\s*(\d+)\s*,\s*(\d+)\s*\)([\s\S]+?)#pragma endFor/g;function n(t,e,n,r,a){let s="";let i=parseInt(n);let m=parseInt(r);if(i.isNaN||m.isNaN){console.error("Unroll For Loops Error: begin and end of range must be an int num.")}for(let t=i;t<m;++t){s+=a.replace(new RegExp(`{${e}}`,"g"),t)}return s}return t.replace(e,n)}class ge{constructor(t,e=[],n={}){this._device=t;this._precision=`precision highp float;\n`;this._templates={};for(let t=0;t<e.length;++t){let n=e[t];this.define(n.name,n.vert,n.frag,n.defines)}this._chunks={};Object.assign(this._chunks,n);this._cache={}}define(t,e,n,r){if(this._templates[t]){console.warn(`Failed to define shader ${t}: already exists.`);return}let a=++ce;let s=0;for(let t=0;t<r.length;++t){let e=r[t];e._offset=s;let n=1;if(e.min!==undefined&&e.max!==undefined){n=Math.ceil((e.max-e.min)*.5);e._map=function(t){return t-this._min<<e._offset}.bind(e)}else{e._map=function(t){if(t){return 1<<e._offset}return 0}.bind(e)}s+=n;e._offset=s}e=this._precision+e;n=this._precision+n;this._templates[t]={id:a,name:t,vert:e,frag:n,defines:r}}getKey(t,e){let n=this._templates[t];let r=0;for(let t=0;t<n.defines.length;++t){let a=n.defines[t];let s=e[a.name];if(s===undefined){continue}r|=a._map(s)}return r<<8|n.id}getProgram(t,e){let n=this.getKey(t,e);let r=this._cache[n];if(r){return r}let a=this._templates[t];let s=_e(e)+"\n";let i=de(a.vert,e);i=s+xe(i);let m=de(a.frag,e);m=s+xe(m);r=new gfx.Program(this._device,{vert:i,frag:m});r.link();this._cache[n]=r;return r}}let pe=Y.create();let ye=it.create();let Me=new ue(()=>{return{stage:null,items:null}},8);let we=new ue(()=>{return new Float32Array(2)},8);let Ae=new ue(()=>{return new Float32Array(3)},8);let ve=new ue(()=>{return new Float32Array(4)},8);let Se=new ue(()=>{return new Float32Array(9)},8);let be=new ue(()=>{return new Float32Array(16)},8);let Ee=new ue(()=>{return new Float32Array(64)},8);let ze=new ue(()=>{return new Int32Array(2)},8);let Te=new ue(()=>{return new Int32Array(3)},8);let Pe=new ue(()=>{return new Int32Array(4)},8);let Re=new ue(()=>{return new Int32Array(64)},8);let Le={[dt.PARAM_INT]:function(t){return t},[dt.PARAM_INT2]:function(t){return U.array(ze.add(),t)},[dt.PARAM_INT3]:function(t){return k.array(Te.add(),t)},[dt.PARAM_INT4]:function(t){return $.array(Pe.add(),t)},[dt.PARAM_FLOAT]:function(t){return t},[dt.PARAM_FLOAT2]:function(t){return U.array(we.add(),t)},[dt.PARAM_FLOAT3]:function(t){return k.array(Ae.add(),t)},[dt.PARAM_FLOAT4]:function(t){return $.array(ve.add(),t)},[dt.PARAM_COLOR3]:function(t){return lt.array(Ae.add(),t)},[dt.PARAM_COLOR4]:function(t){return ft.array(ve.add(),t)},[dt.PARAM_MAT2]:function(t){return tt.array(ve.add(),t)},[dt.PARAM_MAT3]:function(t){return Y.array(Se.add(),t)},[dt.PARAM_MAT4]:function(t){return it.array(be.add(),t)}};let Ce={[dt.PARAM_INT]:{func(t){let e=Re.add();for(let n=0;n<t.length;++n){e[n]=t[n]}return e},size:1},[dt.PARAM_INT2]:{func(t){let e=Re.add();for(let n=0;n<t.length;++n){e[2*n]=t[n].x;e[2*n+1]=t[n].y}return e},size:2},[dt.PARAM_INT3]:{func:undefined,size:3},[dt.PARAM_INT4]:{func(t){let e=Re.add();for(let n=0;n<t.length;++n){let r=t[n];e[4*n]=r.x;e[4*n+1]=r.y;e[4*n+2]=r.z;e[4*n+3]=r.w}return e},size:4},[dt.PARAM_FLOAT]:{func(t){let e=Ee.add();for(let n=0;n<t.length;++n){e[n]=t[n]}return e},size:1},[dt.PARAM_FLOAT2]:{func(t){let e=Ee.add();for(let n=0;n<t.length;++n){e[2*n]=t[n].x;e[2*n+1]=t[n].y}return e},size:2},[dt.PARAM_FLOAT3]:{func:undefined,size:3},[dt.PARAM_FLOAT4]:{func(t){let e=Ee.add();for(let n=0;n<t.length;++n){let r=t[n];e[4*n]=r.x;e[4*n+1]=r.y;e[4*n+2]=r.z;e[4*n+3]=r.w}return e},size:4},[dt.PARAM_COLOR3]:{func:undefined,size:3},[dt.PARAM_COLOR4]:{func(t){let e=Ee.add();for(let n=0;n<t.length;++n){let r=t[n];e[4*n]=r.r;e[4*n+1]=r.g;e[4*n+2]=r.b;e[4*n+3]=r.a}return e},size:4},[dt.PARAM_MAT2]:{func(t){let e=Ee.add();for(let n=0;n<t.length;++n){let r=t[n];e[4*n]=r.m00;e[4*n+1]=r.m01;e[4*n+2]=r.m02;e[4*n+3]=r.m03}return e},size:4},[dt.PARAM_MAT3]:{func:undefined,size:9},[dt.PARAM_MAT4]:{func(t){let e=Ee.add();for(let n=0;n<t.length;++n){let r=t[n];e[16*n]=r.m00;e[16*n+1]=r.m01;e[16*n+2]=r.m02;e[16*n+3]=r.m03;e[16*n+4]=r.m04;e[16*n+5]=r.m05;e[16*n+6]=r.m06;e[16*n+7]=r.m07;e[16*n+8]=r.m08;e[16*n+9]=r.m09;e[16*n+10]=r.m10;e[16*n+11]=r.m11;e[16*n+12]=r.m12;e[16*n+13]=r.m13;e[16*n+14]=r.m14;e[16*n+15]=r.m15}return e},size:16}};class De{constructor(t,e){this._device=t;this._programLib=new ge(t,e.programTemplates,e.programChunks);this._opts=e;this._type2defaultValue={[dt.PARAM_INT]:0,[dt.PARAM_INT2]:U.new(0,0),[dt.PARAM_INT3]:k.new(0,0,0),[dt.PARAM_INT4]:$.new(0,0,0,0),[dt.PARAM_FLOAT]:0,[dt.PARAM_FLOAT2]:U.new(0,0),[dt.PARAM_FLOAT3]:k.new(0,0,0),[dt.PARAM_FLOAT4]:$.new(0,0,0,0),[dt.PARAM_COLOR3]:lt.new(0,0,0),[dt.PARAM_COLOR4]:ft.new(0,0,0,1),[dt.PARAM_MAT2]:tt.create(),[dt.PARAM_MAT3]:Y.create(),[dt.PARAM_MAT4]:it.create(),[dt.PARAM_TEXTURE_2D]:e.defaultTexture,[dt.PARAM_TEXTURE_CUBE]:e.defaultTextureCube};this._stage2fn={};this._usedTextureUnits=0;this._viewPools=new ue(()=>{return new Ct},8);this._drawItemsPools=new ue(()=>{return{model:null,node:null,ia:null,effect:null,defines:null}},100);this._stageItemsPools=new ue(()=>{return new ue(()=>{return{model:null,node:null,ia:null,effect:null,defines:null,technique:null,sortKey:-1}},100)},16)}_resetTextuerUnit(){this._usedTextureUnits=0}_allocTextuerUnit(){const t=this._device;let e=this._usedTextureUnits;if(e>=t._caps.maxTextureUnits){console.warn(`Trying to use ${e} texture units while this GPU supports only ${t._caps.maxTextureUnits}`)}this._usedTextureUnits+=1;return e}_registerStage(t,e){this._stage2fn[t]=e}_reset(){this._viewPools.reset();this._stageItemsPools.reset()}_requestView(){return this._viewPools.add()}_render(t,e){const n=this._device;n.setFrameBuffer(t._framebuffer);n.setViewport(t._rect.x,t._rect.y,t._rect.w,t._rect.h);let r={};if(t._clearFlags&dt.CLEAR_COLOR){r.color=[t._color.r,t._color.g,t._color.b,t._color.a]}if(t._clearFlags&dt.CLEAR_DEPTH){r.depth=t._depth}if(t._clearFlags&dt.CLEAR_STENCIL){r.stencil=t._stencil}n.clear(r);this._drawItemsPools.reset();for(let n=0;n<e._models.length;++n){let r=e._models.data[n];if(t._cullingByID){if(r._viewID!==t._id){continue}}else{if(r._viewID!==-1){continue}}for(let t=0;t<r.drawItemCount;++t){let e=this._drawItemsPools.add();r.extractDrawItem(e,t)}}Me.reset();for(let e=0;e<t._stages.length;++e){let n=t._stages[e];let r=this._stageItemsPools.add();r.reset();for(let t=0;t<this._drawItemsPools.length;++t){let e=this._drawItemsPools.data[t];let a=e.effect.getTechnique(n);if(a){let t=r.add();t.model=e.model;t.node=e.node;t.ia=e.ia;t.effect=e.effect;t.defines=e.defines;t.technique=a;t.sortKey=-1}}let a=Me.add();a.stage=n;a.items=r}for(let e=0;e<Me.length;++e){let n=Me.data[e];let r=this._stage2fn[n.stage];r(t,n.items)}}_draw(t){const e=this._device;const n=this._programLib;const{node:r,ia:a,effect:s,technique:i,defines:m}=t;we.reset();Ae.reset();ve.reset();Se.reset();be.reset();Ee.reset();ze.reset();Te.reset();Pe.reset();Re.reset();r.getWorldMatrix(ye);e.setUniform("model",it.array(be.add(),ye));Y.transpose(pe,Y.invert(pe,Y.fromMat4(pe,ye)));e.setUniform("normalMatrix",Y.array(Se.add(),pe));for(let t=0;t<i._parameters.length;++t){let n=i._parameters[t];let r=s.getProperty(n.name);if(r===undefined){r=n.val}if(r===undefined){r=this._type2defaultValue[n.type]}if(r===undefined){console.warn(`Failed to set technique property ${n.name}, value not found.`);continue}if(n.type===dt.PARAM_TEXTURE_2D||n.type===dt.PARAM_TEXTURE_CUBE){if(n.size!==undefined){if(n.size!==r.length){console.error(`The length of texture array (${r.length}) is not corrent(expect ${n.size}).`);continue}let t=Re.add();for(let e=0;e<r.length;++e){t[e]=this._allocTextuerUnit()}e.setTextureArray(n.name,r,t)}else{e.setTexture(n.name,r,this._allocTextuerUnit())}}else{let t;if(n.size!==undefined){let e=Ce[n.type];if(e.func===undefined){console.error("Uniform array of color3/int3/float3/mat3 can not be supportted!");continue}if(n.size*e.size>64){console.error("Uniform array is too long!");continue}t=e.func(r)}else{let e=Le[n.type];t=e(r)}e.setUniform(n.name,t)}}for(let t=0;t<i._passes.length;++t){let r=i._passes[t];let s=a.getPrimitiveCount();e.setVertexBuffer(0,a._vertexBuffer);if(a._indexBuffer){e.setIndexBuffer(a._indexBuffer)}e.setPrimitiveType(a._primitiveType);let o=n.getProgram(r._programName,m);e.setProgram(o);e.setCullMode(r._cullMode);if(r._blend){e.enableBlend();e.setBlendFuncSep(r._blendSrc,r._blendDst,r._blendSrcAlpha,r._blendDstAlpha);e.setBlendEqSep(r._blendEq,r._blendAlphaEq);e.setBlendColor32(r._blendColor)}if(r._depthTest){e.enableDepthTest();e.setDepthFunc(r._depthFunc)}if(r._depthWrite){e.enableDepthWrite()}if(r._stencilTest){e.enableStencilTest();e.setStencilFuncFront(r._stencilFuncFront,r._stencilRefFront,r._stencilMaskFront);e.setStencilOpFront(r._stencilFailOpFront,r._stencilZFailOpFront,r._stencilZPassOpFront,r._stencilWriteMaskFront);e.setStencilFuncBack(r._stencilFuncBack,r._stencilRefBack,r._stencilMaskBack);e.setStencilOpBack(r._stencilFailOpBack,r._stencilZFailOpBack,r._stencilZPassOpBack,r._stencilWriteMaskBack)}e.draw(a._start,s);this._resetTextuerUnit()}}}let Oe={addStage:Mt.addStage,createIA:Pt,Pass:gt,Technique:At,Effect:vt,InputAssembler:xt,View:Ct,Light:Vt,Camera:Gt,Model:Wt,Scene:fe,Base:De,ProgramLib:ge};Object.assign(Oe,dt);let Ie=k.create();let Ne=k.create();let Fe=k.create();let Be=new Float32Array(16);let Ue=new Float32Array(16);let Ve=new Float32Array(16);Oe.addStage("transparent");class qe extends Oe.Base{constructor(t,e){super(t,e);this._registerStage("transparent",this._transparentStage.bind(this))}render(t){this._reset();for(let e=0;e<t._cameras.length;++e){let n=t._cameras.data[e].getView();this._render(n,t)}}_transparentStage(t,e){this._device.setUniform("view",it.array(Be,t._matView));this._device.setUniform("proj",it.array(Ue,t._matProj));this._device.setUniform("viewProj",it.array(Ve,t._matViewProj));for(let t=0;t<e.length;++t){let n=e.data[t];let r=n.ia;let a=r._vertexBuffer;let s=r._indexBuffer;a.update(0,a._data);s.update(0,s._data);this._draw(n)}}}class ke{constructor(t){let e;try{e=t.getContext("2d")}catch(t){console.error(t);return}this._canvas=t;this._ctx=e;this._caps={};this._stats={drawcalls:0};this._vx=this._vy=this._vw=this._vh=0;this._sx=this._sy=this._sw=this._sh=0}_restoreTexture(t){}setViewport(t,e,n,r){if(this._vx!==t||this._vy!==e||this._vw!==n||this._vh!==r){this._vx=t;this._vy=e;this._vw=n;this._vh=r}}setScissor(t,e,n,r){if(this._sx!==t||this._sy!==e||this._sw!==n||this._sh!==r){this._sx=t;this._sy=e;this._sw=n;this._sh=r}}clear(t){let e=this._ctx;e.clearRect(this._vx,this._vy,this._vw,this._vh);if(t&&(t[0]!==0||t[1]!==0||t[2]!==0)){e.fillStyle="rgb("+t[0]+","+t[1]+","+t[2]+")";e.globalAlpha=t[3];e.fillRect(this._vx,this._vy,this._vw,this._vh)}}}const je=[0,0,0,1];class He{constructor(t,e){this._device=t;this._opts=e;this._stage2fn={};this._drawItemsPools=new ue(()=>{return{model:null,node:null}},100)}_registerStage(t,e){this._stage2fn[t]=e}_reset(){this._drawItemsPools.reset()}_render(t,e){const n=this._device;let r=t._stages[0];let a=n._ctx;let s=camera._viewProj;a.setTransform(s.m00,s.m01,s.m04,s.m05,s.m12,s.m13);n.setViewport(0,0,camera._rect.w,camera._rect.h);n.clear(je);let i=this._drawItemsPools.alloc();i.reset();for(let t=0;t<e._models.length;++t){let n=e._models.data[t];let r=i.add();n.extractDrawItem(r)}let m=this._stage2fn[stages[0]];m(t,i)}_draw(t){const e=this._device;const n=e._ctx;t.model.draw(n)}}var $e={Base:He};class Ge{constructor(t,e){this._device=t;this._width=4;this._height=4;this._image=null;if(e){if(e.width!==undefined){this._width=e.width}if(e.height!==undefined){this._height=e.height}if(e.images&&e.images[0]){let t={image:e.images[0]};this.updateImage(t)}}}update(t){this.updateImage(t)}updateImage(t){if(t.image&&t.image!==this._image){this._image=t.image}}destroy(){this._image=null}}var We={Device:ke,renderer:$e,Texture2D:Ge};const Ye=We.renderer;class Xe extends Ye.Base{constructor(t,e){super(t,e);this._registerStage("transparent",this._transparentStage.bind(this))}reset(){this._reset()}render(t,e){this.reset();this._render(t,e)}_transparentStage(t,e){let n=this._device._ctx;let r=t._viewProj;for(let t=0,a=e.length;t<a;++t){n.setTransform(r.m00,r.m01,r.m04,r.m05,r.m12,r.m13);let a=e.data[t];this._draw(a)}}}var Ze={};var Je=[{name:"gray_sprite",vert:"uniform mat4 viewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying lowp vec4 v_fragmentColor;\nattribute vec2 a_uv0;\nvarying vec2 uv0;\nvoid main () {\n  vec4 pos = viewProj * vec4(a_position, 1);\n  v_fragmentColor = a_color;\n  uv0 = a_uv0;\n  gl_Position = pos;\n}",frag:"uniform sampler2D texture;\nvarying vec2 uv0;\nvarying vec4 v_fragmentColor;\nvoid main () {\n  vec4 c = v_fragmentColor * texture2D(texture, uv0);\n  float gray = 0.2126*c.r + 0.7152*c.g + 0.0722*c.b;\n  gl_FragColor = vec4(gray, gray, gray, c.a);\n}",defines:[]},{name:"sprite",vert:"uniform mat4 viewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying lowp vec4 v_fragmentColor;\n#ifdef useModel\n  uniform mat4 model;\n#endif\n#ifdef useTexture\n  attribute vec2 a_uv0;\n  varying vec2 uv0;\n#endif\nvoid main () {\n  mat4 mvp;\n  #ifdef useModel\n    mvp = viewProj * model;\n  #else\n    mvp = viewProj;\n  #endif\n  vec4 pos = mvp * vec4(a_position, 1);\n  v_fragmentColor = a_color;\n  \n  #ifdef useTexture\n    uv0 = a_uv0;\n  #endif\n  gl_Position = pos;\n}",frag:"#ifdef useTexture\n  uniform sampler2D texture;\n  varying vec2 uv0;\n#endif\n#ifdef alphaTest\n  uniform float alphaThreshold;\n#endif\nvarying vec4 v_fragmentColor;\nvoid main () {\n  vec4 o = v_fragmentColor;\n  #ifdef useTexture\n    o *= texture2D(texture, uv0);\n  #endif\n  #ifdef alphaTest\n    if (o.a <= alphaThreshold)\n      discard;\n  #endif\n  gl_FragColor = o;\n}",defines:[]},{name:"vfx_emitter",vert:"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec2 a_quad;\nvarying vec2 index;\nvoid main() {\n    index = (a_quad + 1.0) / 2.0;\n    gl_Position = vec4(a_quad, 0, 1);\n}\n",frag:"uniform sampler2D noise;\nuniform sampler2D state;\nuniform vec2 statesize;\nuniform vec2 noisesize;\nuniform bool stopped;\nuniform float dt;\nuniform float mode;\nuniform float noiseId;\nuniform float emitVar;\nuniform float life;\nuniform float lifeVar;\nuniform vec2 pos;\nuniform vec2 posVar;\nuniform vec4 color;\nuniform vec4 colorVar;\nuniform vec4 endColor;\nuniform vec4 endColorVar;\nuniform float size;\nuniform float sizeVar;\nuniform float endSize;\nuniform float endSizeVar;\nuniform float rot;\nuniform float rotVar;\nuniform float endRot;\nuniform float endRotVar;\nuniform float angle;\nuniform float angleVar;\nuniform float speed;\nuniform float speedVar;\nuniform float radial;\nuniform float radialVar;\nuniform float tangent;\nuniform float tangentVar;\nuniform float radius;\nuniform float radiusVar;\nuniform float endRadius;\nuniform float endRadiusVar;\nuniform float rotatePS;\nuniform float rotatePSVar;\nuniform float sizeScale;\nuniform float accelScale;\nuniform float radiusScale;\nvarying vec2 index;\nconst float BASE = 255.0;\nconst float OFFSET = BASE * BASE / 2.0;\nconst float NOISE_SCALE = 10000.0;\nconst float POSITION_SCALE = 1.0;\nconst float ROTATION_SCALE = 1.0;\nconst float COLOR_SCALE = 1.0;\nconst float LIFE_SCALE = 60.0;\nconst float START_SIZE_EQUAL_TO_END_SIZE = -1.0;\nconst float START_RADIUS_EQUAL_TO_END_RADIUS = -1.0;\nfloat decode(vec2 channels, float scale) {\n    return (dot(channels, vec2(BASE, BASE * BASE)) - OFFSET) / scale;\n}\nvec2 encode(float value, float scale) {\n    value = value * scale + OFFSET;\n    float x = mod(value, BASE);\n    float y = floor(value / BASE);\n    return vec2(x, y) / BASE;\n}\nfloat randomMinus1To1(vec2 randomD) {\n    float random = decode(randomD, NOISE_SCALE);\n    return (random - 0.5) * 2.0;\n}\nbool doEmit (vec4 randomD) {\n    float random1 = decode(randomD.rg, NOISE_SCALE);\n    if (!stopped && (life + lifeVar) * random1 < life) {\n        return true;\n    }\n    else {\n        return false;\n    }\n}\nvec4 initLife (vec4 data, vec4 randomD) {\n    \n    if (doEmit(randomD)) {\n        float random2 = randomMinus1To1(randomD.ba);\n        float plife = life + lifeVar * random2;\n        vec2 l = encode(plife, LIFE_SCALE);\n        return vec4(l, l);\n    }\n    else {\n        return data;\n    }\n}\nvec4 initColor (float randr, float randg, float randb, float randa) {\n    vec4 random = vec4(randr, randg, randb, randa);\n    vec4 result = clamp(color + colorVar * random, 0.0, 255.0);\n    return result / 255.0;\n}\nvec4 initDeltaRG (vec2 startR, vec2 random) {\n    vec2 start = clamp(color.rg + colorVar.rg * startR, 0.0, 255.0);\n    vec2 end = clamp(endColor.rg + endColorVar.rg * random, 0.0, 255.0);\n    vec2 delta = end - start;\n    return vec4(encode(delta.x, COLOR_SCALE), encode(delta.y, COLOR_SCALE));\n}\nvec4 initDeltaBA (vec2 startR, vec2 random) {\n    vec2 start = clamp(color.ba + colorVar.ba * startR, 0.0, 255.0);\n    vec2 end = clamp(endColor.ba + endColorVar.ba * random, 0.0, 255.0);\n    vec2 delta = end - start;\n    return vec4(encode(delta.x, COLOR_SCALE), encode(delta.y, COLOR_SCALE));\n}\nvec4 initSize (float rand1, float rand2) {\n    float start = max(0.0, size + sizeVar * rand1);\n    if (endSize == START_SIZE_EQUAL_TO_END_SIZE) {\n        float delta = 0.0;\n        return vec4(encode(start, sizeScale), encode(delta, sizeScale));\n    }\n    else {\n        float end = max(0.0, endSize + endSizeVar * rand2);\n        float delta = end - start;\n        return vec4(encode(start, sizeScale), encode(delta, sizeScale));\n    }\n}\nvec4 initRotation (float rand1, float rand2) {\n    float start = rot + rotVar * rand1;\n    float end = endRot + endRotVar * rand2;\n    float delta = end - start;\n    return vec4(encode(start, ROTATION_SCALE), encode(delta, ROTATION_SCALE));\n}\nvec4 initControl1 (float rand1, float rand2) {\n    \n    if (mode == 0.0) {\n        float pAngle = angle + angleVar * rand1;\n        float dirX = cos(pAngle);\n        float dirY = sin(pAngle);\n        float pSpeed = speed + speedVar * rand2;\n        return vec4(encode(dirX * pSpeed, POSITION_SCALE), encode(dirY * pSpeed, POSITION_SCALE));\n    }\n    \n    else {\n        float pAngle = angle + angleVar * rand1;\n        float pRadius = radius + radiusVar * rand2;\n        return vec4(encode(pAngle, ROTATION_SCALE), encode(pRadius, radiusScale));\n    }\n}\nvec4 initControl2 (float startR1, float rand1, float rand2) {\n    \n    if (mode == 0.0) {\n        float pRadial = radial + radialVar * rand1;\n        float pTangent = tangent + tangentVar * rand2;\n        return vec4(encode(pRadial, accelScale), encode(pTangent, accelScale));\n    }\n    \n    else {\n        float degreesPerSecond = rotatePS + rotatePSVar * rand1;\n        float pDeltaRadius;\n        if (endRadius == START_RADIUS_EQUAL_TO_END_RADIUS) {\n            pDeltaRadius = 0.0;\n        }\n        else {\n            float pRadius = radius + radiusVar * startR1;\n            pDeltaRadius = (endRadius + endRadiusVar * rand2 - pRadius);\n        }\n        return vec4(encode(degreesPerSecond, ROTATION_SCALE), encode(pDeltaRadius, radiusScale));\n    }\n}\nvec4 initPos (float rand1, float rand2) {\n    vec2 result = pos + posVar * vec2(rand1, rand2);\n    return vec4(encode(result.x, POSITION_SCALE), encode(result.y, POSITION_SCALE));\n}\nvoid main() {\n    vec2 pixel = floor(index * statesize);\n    vec2 pindex = floor(pixel / 3.0);\n    vec2 temp = mod(pixel, vec2(3.0, 3.0));\n    float id = floor(temp.y * 3.0 + temp.x);\n    vec2 noffset = vec2(floor(noiseId / 4.0), mod(noiseId, 4.0));\n    vec2 nid = pixel + noffset;\n    vec4 randomD = texture2D(noise, nid / noisesize);\n    \n    vec4 lifeData = texture2D(state, pindex * 3.0 / statesize);\n    float rest = decode(lifeData.rg, LIFE_SCALE);\n    float life = decode(lifeData.ba, LIFE_SCALE);\n    \n    if (id == 0.0) {\n        vec4 data = texture2D(state, index);\n        if (rest <= 0.0) {\n            gl_FragColor = initLife(data, randomD);\n        }\n        else {\n            gl_FragColor = data;\n        }\n        return;\n    }\n    \n    if (rest > 0.0) {\n        vec4 data = texture2D(state, index);\n        gl_FragColor = data;\n        return;\n    }\n    vec2 lifeNid = pindex * 3.0 + noffset;\n    vec4 lifeRandomD = texture2D(noise, lifeNid / noisesize);\n    bool emitting = doEmit(lifeRandomD);\n    if (!emitting) {\n        vec4 data = texture2D(state, index);\n        gl_FragColor = data;\n        return;\n    }\n    \n    float random1 = randomMinus1To1(randomD.rg);\n    float random2 = randomMinus1To1(randomD.ba);\n    \n    if (id == 1.0) {\n        vec4 randomD3 = texture2D(noise, vec2(nid.x - 1.0, nid.y + 1.0) / noisesize);\n        float random3 = randomMinus1To1(randomD3.rg);\n        float random4 = randomMinus1To1(randomD3.ba);\n        gl_FragColor = initColor(random1, random2, random3, random4);\n        return;\n    }\n    \n    if (id == 2.0) {\n        vec4 randomD1 = texture2D(noise, vec2(nid.x - 1.0, nid.y) / noisesize);\n        float startR1 = randomMinus1To1(randomD1.rg);\n        float startR2 = randomMinus1To1(randomD1.ba);\n        vec2 startR = vec2(startR1, startR2);\n        gl_FragColor = initDeltaRG(startR, vec2(random1, random2));\n        return;\n    }\n    \n    if (id == 3.0) {\n        vec2 startR = vec2(random1, random2);\n        gl_FragColor = initDeltaBA(startR, vec2(random1, random2));\n        return;\n    }\n    \n    if (id == 4.0) {\n        gl_FragColor = initSize(random1, random2);\n        return;\n    }\n    \n    if (id == 5.0) {\n        gl_FragColor = initRotation(random1, random2);\n        return;\n    }\n    \n    if (id == 6.0) {\n        gl_FragColor = initControl1(random1, random2);\n        return;\n    }\n    \n    if (id == 7.0) {\n        vec4 randomD6 = texture2D(noise, vec2(nid.x - 1.0, nid.y) / noisesize);\n        float startR1 = randomMinus1To1(randomD6.rg);\n        gl_FragColor = initControl2(startR1, random1, random2);\n        return;\n    }\n    \n    if (id == 8.0) {\n        gl_FragColor = initPos(random1, random2);\n        return;\n    }\n}",defines:[]},{name:"vfx_particle",vert:"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec2 a_quad;\nuniform mat4 model;\nuniform mat4 viewProj;\nuniform sampler2D state;\nuniform sampler2D quad;\nuniform vec2 statesize;\nuniform vec2 quadsize;\nuniform float z;\nuniform vec2 lb;\nuniform vec2 rt;\nvarying lowp vec4 v_fragmentColor;\nvarying vec2 uv0;\nconst float BASE = 255.0;\nconst float OFFSET = BASE * BASE / 2.0;\nconst float LIFE_SCALE = 60.0;\nconst float POSITION_SCALE = 1.0;\nfloat decode(vec2 channels, float scale) {\n    return (dot(channels, vec2(BASE, BASE * BASE)) - OFFSET) / scale;\n}\nvoid main() {\n    vec2 sIndex = floor(a_quad / 2.0) * 3.0;\n    vec4 lifeData = texture2D(state, sIndex / statesize);\n    float life = decode(lifeData.rg, LIFE_SCALE);\n    if (life <= 0.0) {\n        v_fragmentColor = vec4(0.0, 0.0, 0.0, 0.0);\n        uv0 = vec2(0.0, 0.0);\n        gl_Position = vec4(0.0, 0.0, 0.0, 1.0);\n    }\n    else {\n        vec2 posIndex = a_quad / quadsize;\n        vec4 posData = texture2D(quad, posIndex);\n        vec2 pos = vec2(decode(posData.rg, POSITION_SCALE), decode(posData.ba, POSITION_SCALE));\n        vec2 cIndex = vec2(sIndex.x + 1.0, sIndex.y) / statesize;\n        vec4 color = texture2D(state, cIndex);\n        v_fragmentColor = color;\n        float u, v;\n        vec2 uvId = mod(a_quad, vec2(2.0));\n        if (uvId.x == 0.0) {\n            u = lb.x;\n        }\n        else {\n            u = rt.x;\n        }\n        if (uvId.y == 0.0) {\n            v = lb.y;\n        }\n        else {\n            v = rt.y;\n        }\n        uv0 = vec2(u, v);\n        gl_Position = viewProj * model * vec4(pos, z, 1.0);\n    }    \n}\n",frag:"uniform sampler2D texture;\nvarying vec2 uv0;\nvarying vec4 v_fragmentColor;\nvoid main () {\n  vec4 o = v_fragmentColor;\n  o *= texture2D(texture, uv0);\n  gl_FragColor = o;\n}",defines:[]},{name:"vfx_quad",vert:"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec2 a_quad;\nvarying vec2 index;\nvoid main() {\n    index = (a_quad + 1.0) / 2.0;\n    gl_Position = vec4(a_quad, 0, 1);\n}\n",frag:"uniform sampler2D state;\nuniform vec2 quadsize;\nuniform vec2 statesize;\nuniform float sizeScale;\nvarying vec2 index;\nconst float BASE = 255.0;\nconst float OFFSET = BASE * BASE / 2.0;\nconst float POSITION_SCALE = 1.0;\nconst float ROTATION_SCALE = 1.0;\nfloat decode(vec2 channels, float scale) {\n    return (dot(channels, vec2(BASE, BASE * BASE)) - OFFSET) / scale;\n}\nvec2 encode(float value, float scale) {\n    value = value * scale + OFFSET;\n    float x = mod(value, BASE);\n    float y = floor(value / BASE);\n    return vec2(x, y) / BASE;\n}\nvoid main() {\n    vec2 pIndex = floor(index * quadsize / 2.0) * 3.0;\n    vec2 dataIndex = (pIndex + 2.0) / statesize;\n    vec4 posData = texture2D(state, dataIndex);\n    vec2 pos = vec2(decode(posData.rg, POSITION_SCALE), decode(posData.ba, POSITION_SCALE));\n    dataIndex = (pIndex + 1.0) / statesize;\n    vec4 sizeData = texture2D(state, dataIndex);\n    float size = decode(sizeData.rg, sizeScale);\n    dataIndex.x = (pIndex.x + 2.0) / statesize.x;\n    dataIndex.y = (pIndex.y + 1.0) / statesize.y;\n    vec4 rotData = texture2D(state, dataIndex);\n    float rot = radians(floor(decode(rotData.rg, ROTATION_SCALE)));\n    float a = cos(rot);\n    float b = -sin(rot);\n    float c = -b;\n    float d = a;\n    vec2 vert = (mod(floor(index * quadsize), vec2(2.0)) - 0.5) * size;\n    float x = vert.x * a + vert.y * c + pos.x;\n    float y = vert.x * b + vert.y * d + pos.y;\n    gl_FragColor = vec4(encode(x, POSITION_SCALE), encode(y, POSITION_SCALE));\n}\n",defines:[]},{name:"vfx_update",vert:"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec2 a_quad;\nvarying vec2 index;\nvoid main() {\n    index = (a_quad + 1.0) / 2.0;\n    gl_Position = vec4(a_quad, 0, 1);\n}\n",frag:"uniform sampler2D state;\nuniform vec2 statesize;\nuniform float dt;\nuniform float mode;\nuniform vec2 gravity;\nuniform float sizeScale;\nuniform float accelScale;\nuniform float radiusScale;\nvarying vec2 index;\nconst float BASE = 255.0;\nconst float OFFSET = BASE * BASE / 2.0;\nconst float MAX_VALUE = BASE * BASE;\nconst float LIFE_SCALE = 60.0;\nconst float POSITION_SCALE = 1.0;\nconst float ROTATION_SCALE = 1.0;\nconst float COLOR_SCALE = 1.0;\nfloat decode(vec2 channels, float scale) {\n    return (dot(channels, vec2(BASE, BASE * BASE)) - OFFSET) / scale;\n}\nvec2 encode(float value, float scale) {\n    value = value * scale + OFFSET;\n    float x = mod(value, BASE);\n    float y = floor(value / BASE);\n    return vec2(x, y) / BASE;\n}\nvec4 updateLife (vec4 data) {\n    float rest = decode(data.rg, LIFE_SCALE);\n    rest -= dt;\n    return vec4(encode(rest, LIFE_SCALE), data.ba);\n}\nvec4 updateColor (vec4 color, vec4 deltaRG, vec4 deltaBA, float life) {\n    float r = decode(deltaRG.rg, COLOR_SCALE);\n    float g = decode(deltaRG.ba, COLOR_SCALE);\n    float b = decode(deltaBA.rg, COLOR_SCALE);\n    float a = decode(deltaBA.ba, COLOR_SCALE);\n    vec4 deltaColor = vec4(r, g, b, a) / 255.0;\n    \n    color = clamp(color + deltaColor * dt / life, 0.0, 1.0);\n    return color;\n}\nvec4 updateSize (vec4 data, float life) {\n    float size = decode(data.rg, sizeScale);\n    float deltaSize = decode(data.ba, sizeScale);\n    size = clamp(size + deltaSize * dt / life, 0.0, MAX_VALUE);\n    return vec4(encode(size, sizeScale), data.ba);\n}\nvec4 updateRotation (vec4 data, float life) {\n    float rotation = decode(data.rg, ROTATION_SCALE);\n    float deltaRotation = decode(data.ba, ROTATION_SCALE);\n    rotation += deltaRotation * dt / life;\n    return vec4(encode(rotation, ROTATION_SCALE), data.ba);\n}\nvec4 updateControl (vec4 control1, vec4 control2, vec4 posData, float life) {\n    \n    if (mode == 0.0) {\n        vec2 dir = vec2(decode(control1.rg, POSITION_SCALE), decode(control1.ba, POSITION_SCALE));\n        float radialAccel = decode(control2.rg, accelScale);\n        float tangentialAccel = decode(control2.ba, accelScale);\n        vec2 pos = vec2(decode(posData.rg, POSITION_SCALE), decode(posData.ba, POSITION_SCALE));\n        vec2 radial = normalize(pos);\n        vec2 tangential = vec2(-radial.y, radial.x);\n        radial = radial * radialAccel;\n        tangential = tangential * tangentialAccel;\n        vec2 result = dir + (radial + tangentialAccel + gravity) * dt;\n        return vec4(encode(result.x, POSITION_SCALE), encode(result.y, POSITION_SCALE));\n    }\n    \n    else {\n        float angle = mod(decode(control1.rg, ROTATION_SCALE), 360.0);\n        float radius = decode(control1.ba, radiusScale);\n        float degreesPerSecond = decode(control2.rg, ROTATION_SCALE);\n        float deltaRadius = decode(control2.ba, radiusScale);\n        angle += degreesPerSecond * dt;\n        radius += deltaRadius * dt / life;\n        return vec4(encode(angle, ROTATION_SCALE), encode(radius, radiusScale));\n    }\n}\nvec4 updatePos (vec4 posData, vec4 control) {\n    vec2 result;\n    \n    if (mode == 0.0) {\n        vec2 dir = vec2(decode(control.rg, POSITION_SCALE), decode(control.ba, POSITION_SCALE));\n        vec2 pos = vec2(decode(posData.rg, POSITION_SCALE), decode(posData.ba, POSITION_SCALE));\n        result = pos + dir * dt;\n    }\n    \n    else {\n        float angle = radians(decode(control.rg, ROTATION_SCALE));\n        float radius = decode(control.ba, radiusScale);\n        result.x = -cos(angle) * radius;\n        result.y = -sin(angle) * radius;\n    }\n    return vec4(encode(result.x, POSITION_SCALE), encode(result.y, POSITION_SCALE));\n}\nvoid main() {\n    vec2 pixel = floor(index * statesize);\n    vec2 pindex = floor(pixel / 3.0);\n    vec2 temp = mod(pixel, vec2(3.0));\n    float id = floor(temp.y * 3.0 + temp.x);\n    \n    vec4 data = texture2D(state, index);\n    vec4 lifeData = texture2D(state, pindex * 3.0 / statesize);\n    float rest = decode(lifeData.rg, LIFE_SCALE);\n    if (rest <= 0.0) {\n        gl_FragColor = data;\n        return;\n    }\n    \n    if (id == 2.0 || id == 3.0 || id == 7.0) {\n        gl_FragColor = data;\n        return;\n    }\n    float life = decode(lifeData.ba, LIFE_SCALE);\n    \n    if (id == 0.0) {\n        gl_FragColor = updateLife(data);\n        return;\n    }\n    \n    if (id == 1.0) {\n        vec2 rgIndex = vec2(pixel.x + 1.0, pixel.y) / statesize;\n        vec4 deltaRG = texture2D(state, rgIndex);\n        vec2 baIndex = vec2(pixel.x - 1.0, pixel.y + 1.0) / statesize;\n        vec4 deltaBA = texture2D(state, baIndex);\n        gl_FragColor = updateColor(data, deltaRG, deltaBA, life);\n        return;\n    }\n    \n    if (id == 4.0) {\n        gl_FragColor = updateSize(data, life);\n        return;\n    }\n    \n    if (id == 5.0) {\n        gl_FragColor = updateRotation(data, life);\n        return;\n    }\n    \n    if (id == 6.0) {\n        vec2 ctrlIndex = vec2(pixel.x + 1.0, pixel.y) / statesize;\n        vec4 control2 = texture2D(state, ctrlIndex);\n        vec2 posIndex = vec2(pixel.x + 2.0, pixel.y) / statesize;\n        vec4 pos = texture2D(state, posIndex);\n        gl_FragColor = updateControl(data, control2, pos, life);\n        return;\n    }\n    \n    if (id == 8.0) {\n        vec2 ctrlIndex = vec2(pixel.x - 2.0, pixel.y) / statesize;\n        vec4 control1 = texture2D(state, ctrlIndex);\n        gl_FragColor = updatePos(data, control1);\n        return;\n    }\n}\n",defines:[]}];let Ke={chunks:Ze,templates:Je};function Qe(t,e){try{return t.getContext("webgl",e)||t.getContext("experimental-webgl",e)}catch(t){return null}}let tn=false;if(typeof window==="undefined"){tn=true}else{const t=window.cc&&window.cc.sys;let e=document.createElement("canvas");if(window.WebGLRenderingContext){tn=true;if(tn&&t&&t.os===t.OS_ANDROID){var en=parseFloat(t.browserVersion);switch(t.browserType){case t.BROWSER_TYPE_MOBILE_QQ:case t.BROWSER_TYPE_BAIDU:case t.BROWSER_TYPE_BAIDU_APP:if(en>=6.2){tn=true}else{tn=false}break;case t.BROWSER_TYPE_ANDROID:if(t.osMainVersion&&t.osMainVersion>=5){tn=true}break;case t.BROWSER_TYPE_CHROME:if(en>=30){tn=true}else{tn=false}break;case t.BROWSER_TYPE_UC:if(en>11){tn=true}else{tn=false}case t.BROWSER_TYPE_360:tn=false}}}}var nn={supportWebGL:tn,create3DContext:Qe};class rn{constructor(t,e){this.view=null;this._node=null;this._poolID=-1;this._projection=rn.PROJECTION.PERSPECTIVE;this._color=ft.new(0,0,0,1);this._depth=1;this._stencil=1;this._clearFlags=Oe.CLEAR_COLOR|Oe.CLEAR_DEPTH;this._near=.1;this._far=1024;this._fov=Math.PI*60/180;this._rect={x:0,y:0,w:1,h:1};this._stages=[];this._framebuffer=null;this._matView=it.create();this._matProj=it.create();this._matViewProj=it.create();this._matInvViewProj=it.create();this.setViewport(t);if(e){this.setNode(e)}}setColor(t,e,n,r){ft.set(this._color,t,e,n,r)}setDepth(t){this._depth=t}setStencil(t){this._stencil=t}setClearFlags(t){this._clearFlags=t}setStages(t){this._stages=t}setFramebuffer(t){this._framebuffer=t}setNode(t){this._node=t;this._node.getWorldMatrix(this._matView);it.invert(this._matView,this._matView);it.mul(this._matViewProj,this._matProj,this._matView)}setViewport(t){if(t){this._rect=t}if(nn.supportWebGL){let t=this._rect.w/this._rect.h;if(this._projection===rn.PROJECTION.PERSPECTIVE){let e=this._rect.h/1.1566;let n=it.create();it.perspective(n,this._fov,t,this._near,e*2);let r=k.new(-this._rect.x+this._rect.w/2,-this._rect.y+this._rect.h/2,e);let a=k.new(-this._rect.x+this._rect.w/2,-this._rect.y+this._rect.h/2,0);let s=k.new(0,1,0);let i=it.create();it.lookAt(i,r,a,s);it.mul(this._matProj,n,i)}else{it.ortho(this._matProj,0,this._rect.w,0,this._rect.h,this._near,this._far)}}else{it.identity(this._matProj);this._matProj.m12=this._rect.x;this._matProj.m13=this._rect.y+this._rect.h;this._matProj.m05=-1}it.mul(this._matViewProj,this._matProj,this._matView);it.invert(this._matInvViewProj,this._matViewProj)}getView(){return this}}rn.PROJECTION={PERSPECTIVE:0,ORTHO:1};var an;var sn=new le(()=>{return{x:0,y:0,u:0,v:0,color:0}},128);class mn{constructor(){this._data=[];this._indices=[];this.effect=null;this._pivotX=0;this._pivotY=0;this._width=0;this._height=0;this.vertexCount=0;this.indiceCount=0;this.uvDirty=true;this.vertDirty=true}get dataLength(){return this._data.length}set dataLength(t){let e=this._data;for(let n=t;n<e.length;n++){sn.free(e[n])}for(let n=e.length;n<t;n++){e[n]=sn.alloc()}e.length=t}updateSizeNPivot(t,e,n,r){if(t!==this._width||e!==this._height||n!==this._pivotX||r!==this._pivotY){this._width=t;this._height=e;this._pivotX=n;this._pivotY=r;this.vertDirty=true}}static alloc(){return an.alloc()}static free(t){if(t instanceof mn){for(let e=t.length-1;e>0;e--){sn.free(t._data[e])}t._data.length=0;t._indices.length=0;t.effect=null;t.uvDirty=true;t.vertDirty=true;t.vertexCount=0;t.indiceCount=0;an.free(t)}}}an=new le(()=>{return new mn},32);const on=255;const ln=1e4;const un=1;const hn=60;const fn=1;const cn=1;const _n=500;let dn=new gfx.VertexFormat([{name:"a_quad",type:gfx.ATTR_TYPE_FLOAT32,num:2}]);let xn={width:0,height:0,minFilter:gfx.FILTER_NEAREST,magFilter:gfx.FILTER_NEAREST,wrapS:gfx.WRAP_CLAMP,wrapT:gfx.WRAP_CLAMP,format:gfx.TEXTURE_FMT_RGBA8,images:[]};function gn(t,e,n,r){t=t*e+on*on/2;n[r]=Math.floor(t%on/on*255);n[r+1]=Math.floor(Math.floor(t/on)/on*255)}function pn(t,e,n){return(t[e]/255*on+t[e+1]/255*on*on-on*on/2)/n}function yn(t,e,n){return t<e?e:t<n?t:n}class Mn{constructor(t,e,n){this._device=t;this._config=n;this._sizeScale=1;this._accelScale=1;this._radiusScale=1;let r={};let a=e._programLib;this.programs={emitter:a.getProgram("vfx_emitter",r),update:a.getProgram("vfx_update",r),quad:a.getProgram("vfx_quad",r)};this.textures={state0:new gfx.Texture2D(t,r),state1:new gfx.Texture2D(t,r),noise:new gfx.Texture2D(t,r),quads:new gfx.Texture2D(t,r)};this.framebuffers={state0:new gfx.FrameBuffer(t,0,0,{colors:[this.textures.state0]}),state1:new gfx.FrameBuffer(t,0,0,{colors:[this.textures.state1]}),quads:new gfx.FrameBuffer(t,0,0,{colors:[this.textures.quads]})};let s=new Float32Array([-1,-1,1,-1,-1,1,1,1]);let i=new Uint8Array([0,1,2,1,3,2]);this.buffers={updateVB:new gfx.VertexBuffer(t,dn,gfx.USAGE_STATIC,s,4),updateIB:new gfx.IndexBuffer(t,gfx.INDEX_FMT_UINT8,gfx.USAGE_STATIC,i,6),indexes:null,particleCache:null};this._elapsed=0;this._stopped=false;this.updateMaxParticle(n);this.updateSizeScale(n);this.updateRadiusScale(n);this.updateAccelScale(n);this._pos=new Float32Array([n.sourcePos.x,n.sourcePos.y]);this._posVar=new Float32Array([n.posVar.x,n.posVar.y]);this._gravity=new Float32Array([n.gravity.x,n.gravity.y]);this._color=new Float32Array([n.startColor.r,n.startColor.g,n.startColor.b,n.startColor.a]);this._colorVar=new Float32Array([n.startColorVar.r,n.startColorVar.g,n.startColorVar.b,n.startColorVar.a]);this._endColor=new Float32Array([n.endColor.r,n.endColor.g,n.endColor.b,n.endColor.a]);this._endColorVar=new Float32Array([n.endColorVar.r,n.endColorVar.g,n.endColorVar.b,n.endColorVar.a])}get vertexFormat(){return dn}get particleCount(){let t=0;let e=this._device;e.setFrameBuffer(this.framebuffers.state0);let n=this.statesize[0],r=this.statesize[1],a=this._tw,s=this._th,i=this.buffers.particleCache;e._gl.readPixels(0,0,n,r,e._gl.RGBA,e._gl.UNSIGNED_BYTE,i);for(let e=0;e<s;e++){for(let n=0;n<a;n++){let r=e*3*a*12+n*12;let s=pn(i,r,hn);if(s>0){t++}}}return t}get stopped(){return this._stopped}updateMaxParticle(t){let e=Math.floor(t.emissionRate*(t.life+t.lifeVar));let n;if(t.totalParticles>e){n=e;this._emitVar=t.lifeVar}else{n=t.totalParticles;this._emitVar=0}if(n!==this._maxParticle){this._maxParticle=n;this._tw=Math.ceil(Math.sqrt(n));this._th=Math.floor(Math.sqrt(n));this.initTextures();this.initBuffers()}}set pos(t){this._pos[0]=t.x;this._pos[1]=t.y}set posVar(t){this._posVar[0]=t.x;this._posVar[1]=t.y}set gravity(t){this._gravity[0]=t.x;this._gravity[1]=t.y}set startColor(t){this._color[0]=t.r;this._color[1]=t.g;this._color[2]=t.b;this._color[3]=t.a}set startColorVar(t){this._colorVar[0]=t.r;this._colorVar[1]=t.g;this._colorVar[2]=t.b;this._colorVar[3]=t.a}set endColor(t){this._endColor[0]=t.r;this._endColor[1]=t.g;this._endColor[2]=t.b;this._endColor[3]=t.a}set endColorVar(t){this._endColorVar[0]=t.r;this._endColorVar[1]=t.g;this._endColorVar[2]=t.b;this._endColorVar[3]=t.a}_updateTex(t,e,n,r){xn.images.length=1;xn.images[0]=e;xn.width=n;xn.height=r;t.update(xn)}_initNoise(){let t=this._tw,e=this._th;let n=(t+1)*3,r=(e+1)*3;let a=new Uint8Array(n*r*4);let s=0;for(let t=0;t<r;t++){for(let t=0;t<n;t++){gn(Math.random(),ln,a,s);gn(Math.random(),ln,a,s+2);s+=4}}this._noisesize=new Float32Array([n,r]);this._updateTex(this.textures.noise,a,n,r)}initTextures(){let t=this._tw,e=this._th;this.statesize=new Float32Array([t*3,e*3]);this.quadsize=new Float32Array([t*2,e*2]);let n=new Uint8Array(t*3*e*3*4);n.fill(97);this._updateTex(this.textures.state0,n,t*3,e*3);this._updateTex(this.textures.state1,n,t*3,e*3);this._updateTex(this.textures.quads,null,t*2,e*2);this._initNoise()}initBuffers(){var t=this.quadsize[0],e=this.quadsize[1],n=new Float32Array(t*e*2),r=0;for(var a=0;a<e;a++){for(var s=0;s<t;s++){n[r+0]=s;n[r+1]=a;r+=2}}this.buffers.indexes=n;this.buffers.particleCache=new Uint8Array(this.statesize[0]*this.statesize[1]*4)}updateSizeScale(t){let e=t.startSize,n=t.startSizeVar,r=t.endSize,a=t.endSizeVar;let s=Math.floor(Math.pow(on,2)/Math.max(e+n,r+a));this._sizeScale=yn(s,1,_n)}updateAccelScale(t){let e=t.radialAccel,n=t.radialAccelVar,r=t.tangentialAccel,a=t.tangentialAccelVar;let s=Math.floor(Math.pow(on,2)/Math.max(Math.abs(e)+n,Math.abs(r)+a)/2);this._accelScale=yn(s,1,_n)}updateRadiusScale(t){let e=t.startRadius,n=t.startRadiusVar,r=t.endRadius,a=t.endRadiusVar;let s=Math.floor(Math.pow(on,2)/Math.max(Math.abs(e)+n,Math.abs(r)+a));this._radiusScale=yn(s,1,_n)}resetSystem(){this._stopped=false}stopSystem(){this._stopped=true}getState(t){let e=this._device;e.setFrameBuffer(t);let n=this.statesize[0],r=this.statesize[1],a=this._tw,s=this._th,i=new Uint8Array(n*r*4);e._gl.readPixels(0,0,n,r,e._gl.RGBA,e._gl.UNSIGNED_BYTE,i);let m=[];for(let t=0;t<s;t++){for(let e=0;e<a;e++){let n=t*3*a*12+e*12;let r=n+1*4;let s=n+2*4;let o=n+a*12;let l=n+a*12+1*4;let u=n+a*12+2*4;let h=n+2*a*12;let f=n+2*a*12+1*4;let c=n+2*a*12+2*4;let _=pn(i,n,hn);let d=pn(i,n+2,hn);let x={r:i[r],g:i[r+1],b:i[r+2],a:i[r+3]};let g={r:pn(i,s,fn),g:pn(i,s+2,fn),b:pn(i,o,fn),a:pn(i,o+2,fn)};let p=pn(i,l,this._sizeScale);let y=pn(i,l+2,this._sizeScale);let M=pn(i,u,cn);let w=pn(i,u+2,cn);let A;if(this._config.emitterMode===0){A=[pn(i,h,un),pn(i,h+2,un),pn(i,f,this._accelScale),pn(i,f+2,this._accelScale)]}else{A=[pn(i,h,cn),pn(i,h+2,this._radiusScale),pn(i,f,cn),pn(i,f+2,this._radiusScale)]}let v={x:pn(i,c,un),y:pn(i,c+2,un)};m.push({rest:_,life:d,color:x,deltaColor:g,size:p,deltaSize:y,rot:M,deltaRot:w,control:A,pos:v})}}return m}getNoise(){let t=this._device;let e=new gfx.FrameBuffer(t,0,0,{colors:[this.textures.noise]});t.setFrameBuffer(e);let n=this._noisesize[0],r=this._noisesize[1],a=new Uint8Array(n*r*4);t._gl.readPixels(0,0,n,r,t._gl.RGBA,t._gl.UNSIGNED_BYTE,a);let s=[];let i=0;for(let t=0;t<r;t++){for(let t=0;t<n;t++){s.push(pn(a,i,1e4));s.push(pn(a,i+2,1e4));i+=4}}return s}getQuads(){let t=this._device;let e=new gfx.FrameBuffer(t,0,0,{colors:[this.textures.quads]});t.setFrameBuffer(e);let n=this.quadsize[0],r=this.quadsize[1],a=new Uint8Array(n*r*4);t._gl.readPixels(0,0,n,r,t._gl.RGBA,t._gl.UNSIGNED_BYTE,a);let s=[];let i=0,m=0;for(let t=0;t<r;t+=2){for(let e=0;e<n;e+=2){i=(t*n+e)*4;m=((t+1)*n+e)*4;s.push([pn(a,i,un),pn(a,i+2,un),pn(a,i+4,un),pn(a,i+6,un),pn(a,m,un),pn(a,m+2,un),pn(a,m+4,un),pn(a,m+6,un)])}}return s}step(t){let e=this._config;let n=this._device;n.setViewport(0,0,this.statesize[0],this.statesize[1]);n.setFrameBuffer(this.framebuffers.state1);n.setTexture("noise",this.textures.noise,0);n.setTexture("state",this.textures.state0,1);n.setUniform("statesize",this.statesize);n.setUniform("noisesize",this._noisesize);n.setUniform("stopped",this._stopped);n.setUniform("dt",t);n.setUniform("mode",e.emitterMode);n.setUniform("noiseId",Math.floor(Math.random()*16));n.setUniform("emitVar",this._emitVar);n.setUniform("life",e.life);n.setUniform("lifeVar",e.lifeVar);n.setUniform("pos",this._pos);n.setUniform("posVar",this._posVar);n.setUniform("color",this._color);n.setUniform("colorVar",this._colorVar);n.setUniform("endColor",this._endColor);n.setUniform("endColorVar",this._endColorVar);n.setUniform("size",e.startSize);n.setUniform("sizeVar",e.startSizeVar);n.setUniform("endSize",e.endSize);n.setUniform("endSizeVar",e.endSizeVar);n.setUniform("rot",e.startSpin);n.setUniform("rotVar",e.startSpinVar);n.setUniform("endRot",e.endSpin);n.setUniform("endRotVar",e.endSpinVar);n.setUniform("angle",e.angle);n.setUniform("angleVar",e.angleVar);n.setUniform("speed",e.speed);n.setUniform("speedVar",e.speedVar);n.setUniform("radial",e.radialAccel);n.setUniform("radialVar",e.radialAccelVar);n.setUniform("tangent",e.tangentialAccel);n.setUniform("tangentVar",e.tangentialAccelVar);n.setUniform("radius",e.startRadius);n.setUniform("radiusVar",e.startRadiusVar);n.setUniform("endRadius",e.endRadius);n.setUniform("endRadiusVar",e.endRadiusVar);n.setUniform("rotatePS",e.rotatePerS);n.setUniform("rotatePSVar",e.rotatePerSVar);n.setUniform("sizeScale",this._sizeScale);n.setUniform("accelScale",this._accelScale);n.setUniform("radiusScale",this._radiusScale);n.setVertexBuffer(0,this.buffers.updateVB);n.setIndexBuffer(this.buffers.updateIB);n.setProgram(this.programs.emitter);n.draw(0,this.buffers.updateIB.count);n.setFrameBuffer(this.framebuffers.state0);n.setTexture("state",this.textures.state1,0);n.setUniform("statesize",this.statesize);n.setUniform("dt",t);n.setUniform("mode",e.emitterMode);n.setUniform("gravity",this._gravity);n.setUniform("sizeScale",this._sizeScale);n.setUniform("accelScale",this._accelScale);n.setUniform("radiusScale",this._radiusScale);n.setVertexBuffer(0,this.buffers.updateVB);n.setIndexBuffer(this.buffers.updateIB);n.setProgram(this.programs.update);n.draw(0,this.buffers.updateIB.count);n.setViewport(0,0,this._tw*2,this._th*2);n.setFrameBuffer(this.framebuffers.quads);n.setTexture("state",this.textures.state0,0);n.setUniform("quadsize",this.quadsize);n.setUniform("statesize",this.statesize);n.setUniform("sizeScale",this._sizeScale);n.setVertexBuffer(0,this.buffers.updateVB);n.setIndexBuffer(this.buffers.updateIB);n.setProgram(this.programs.quad);n.draw(0,this.buffers.updateIB.count);this._elapsed+=t;if(e.duration!==-1&&e.duration<this._elapsed){this.stopSystem()}}}class wn{constructor(t=true){this._loaded=false;this._persist=t}unload(){this._loaded=false}reload(){}}class An extends wn{constructor(t=false){super(t);this._effect=null}}class vn{constructor(){this._cache={}}get(t){return this._cache[t]}register(t,e){if(t===undefined||this._cache[t]){console.warn("Material key is invalid or already exists")}else if(!e instanceof An){console.warn("Invalid Material")}else{this._cache[t]=e}}unregister(t){if(t!==undefined){delete this._cache[t]}}}class Sn extends An{constructor(){super(false);var t=new Oe.Pass("sprite");t.setDepth(false,false);t.setCullMode(gfx.CULL_NONE);t.setBlend(gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA,gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA);let e=new Oe.Technique(["transparent"],[{name:"texture",type:Oe.PARAM_TEXTURE_2D}],[t]);this._effect=new Oe.Effect([e],{},[{name:"useTexture",value:true},{name:"useModel",value:false},{name:"alphaTest",value:false}]);this._mainTech=e}get effect(){return this._effect}set useTexture(t){this._effect.define("useTexture",t)}set useModel(t){this._effect.define("useModel",t)}get texture(){return this._effect.getProperty("texture")}set texture(t){this._effect.setProperty("texture",t)}clone(){let t=this._effect._values,e={};for(let n in t){let r=t[n];e[n]=r[n]}let n=new Sn(e);n.texture=this.texture;return n}}class bn extends An{constructor(){super(false);var t=new Oe.Pass("gray_sprite");t.setDepth(false,false);t.setCullMode(gfx.CULL_NONE);t.setBlend(gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA,gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA);let e=new Oe.Technique(["transparent"],[{name:"texture",type:Oe.PARAM_TEXTURE_2D}],[t]);this._effect=new Oe.Effect([e],{},[]);this._mainTech=e}get effect(){return this._effect}get texture(){return this._effect.getProperty("texture")}set texture(t){this._effect.setProperty("texture",t)}clone(){let t=this._effect._values,e={};for(let n in t){let r=t[n];e[n]=r[n]}let n=new bn(e);n.texture=this.texture;return n}}class En extends An{constructor(){super(false);this._pass=new Oe.Pass("sprite");this._pass.setDepth(false,false);this._pass.setCullMode(gfx.CULL_NONE);this._pass.setBlend(gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA,gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA);let t=new Oe.Technique(["transparent"],[{name:"texture",type:Oe.PARAM_TEXTURE_2D},{name:"alphaThreshold",type:Oe.PARAM_FLOAT}],[this._pass]);this._effect=new Oe.Effect([t],{},[{name:"useTexture",value:true},{name:"useModel",value:false},{name:"alphaTest",value:true}]);this._mainTech=t}get effect(){return this._effect}get useTexture(){this._effect.getDefine("useTexture",val)}set useTexture(t){this._effect.define("useTexture",t)}get texture(){return this._effect.getProperty("texture")}set texture(t){this._effect.setProperty("texture",t)}get alphaThreshold(){return this._effect.getProperty("alphaThreshold")}set alphaThreshold(t){this._effect.setProperty("alphaThreshold",t)}clone(){let t=this._effect._values,e={};for(let n in t){let r=t[n];e[n]=r[n]}let n=new En(e);n.useTexture=this.useTexture;n.texture=this.texture;n.alphaThreshold=this.alphaThreshold;return n}}class zn extends An{constructor(){super(false);var t=new Oe.Pass("vfx_particle");t.setDepth(false,false);t.setCullMode(gfx.CULL_NONE);t.setBlend(gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA,gfx.BLEND_FUNC_ADD,gfx.BLEND_SRC_ALPHA,gfx.BLEND_ONE_MINUS_SRC_ALPHA);let e=new Oe.Technique(["transparent"],[{name:"texture",type:Oe.PARAM_TEXTURE_2D},{name:"state",type:Oe.PARAM_TEXTURE_2D},{name:"quad",type:Oe.PARAM_TEXTURE_2D},{name:"z",type:Oe.PARAM_FLOAT},{name:"statesize",type:Oe.PARAM_FLOAT2},{name:"quadsize",type:Oe.PARAM_FLOAT2},{name:"lb",type:Oe.PARAM_FLOAT2},{name:"rt",type:Oe.PARAM_FLOAT2}],[t]);this._effect=new Oe.Effect([e],{},[]);this._mainTech=e;this._lb=U.create();this._rt=U.create()}get effect(){return this._effect}get texture(){return this._effect.getProperty("texture")}set texture(t){this._effect.setProperty("texture",t)}get stateMap(){return this._effect.getProperty("state")}set stateMap(t){this._effect.setProperty("state",t)}get quadMap(){return this._effect.getProperty("quad")}set quadMap(t){this._effect.setProperty("quad",t)}get stateSize(){return this._effect.getProperty("statesize")}set stateSize(t){this._effect.setProperty("statesize",t)}get quadSize(){return this._effect.getProperty("quadsize")}set quadSize(t){this._effect.setProperty("quadsize",t)}get z(){return this._effect.getProperty("z")}set z(t){this._effect.setProperty("z",t)}get uv(){let t=this._effect.getProperty("lb");let e=this._effect.getProperty("rt");return{l:t.x,r:e.x,b:t.y,t:e.y}}set uv(t){this._lb.x=t.l;this._lb.y=t.b;this._rt.x=t.r;this._rt.y=t.t;this._effect.setProperty("lb",this._lb);this._effect.setProperty("rt",this._rt)}clone(){let t=this._effect._values,e={};for(let n in t){let r=t[n];e[n]=r[n]}let n=new zn(e);n.texture=this.texture;n.stateMap=this.stateMap;n.quadMap=this.quadMap;n.stateSize=this.stateSize;n.quadSize=this.quadSize;n.z=this.z;n.uv=this.uv;return n}}const Tn=Oe.Scene;const Pn=nn.supportWebGL?qe:Xe;const Rn=nn.supportWebGL?gfx.Texture2D:We.Texture2D;const Ln=nn.supportWebGL?gfx.Device:We.Device;const Cn=Oe.Model;const Dn=Oe.InputAssembler;let On={Device:Ln,ForwardRenderer:Pn,Texture2D:Rn,Scene:Tn,Camera:rn,Model:Cn,RenderData:mn,InputAssembler:Dn,Particles:Mn,Asset:wn,Material:An,SpriteMaterial:Sn,GraySpriteMaterial:bn,StencilMaterial:En,ParticleMaterial:zn,shaders:Ke,renderMode:nn,MaterialUtil:vn,RecyclePool:ue,Pool:le,math:_t,renderer:Oe,gfx:gfx,canvas:We};return On}();
//# sourceMappingURL=engine.min.js.map